---
title: "NIR Processing"
author: "Eric Coronel"
date: "3/25/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

# R Packages And Other Global Options

library(tidyverse)
library(readxl)
library(usdarnass)
library(zoo)

nass_set_key("40DCDA93-B5E8-33FB-B96F-47902CD5E5A0") # for NASS API queries
options(scipen = 999)

# Custom Functions

coronel_qc <- function(data, batch_name = "_regular") {
  
  vector_names <- names(data) %>% 
    tail(n = length(names(data)) - 2)
  
  for (i in 1:length(vector_names)) {
    graph01 <- ggplot(data, aes(x = year, y = get(vector_names[i]), group = crop)) +
      geom_line() +
      geom_point() +
      labs(title = paste(vector_names[i]), y = paste(vector_names[i])) +
      facet_wrap(~ crop, scales = "free") +
      geom_blank(aes(y = 0))
    
    print(paste(vector_names[i], "-", i, "out of", length(vector_names)))
    ggsave(plot = graph01, filename = paste0("temp_qc_output/", str_pad(i, 2, pad = "0"), "_", vector_names[i],
                                             batch_name, ".png"))
  }
}

coronel_one_off_graph <- function(data, x, y) {
  ggplot(data, aes(get(x), get(y))) +
  geom_point() +
  facet_wrap(~ crop, scales = "free") +
      geom_blank(aes(y = 0))
}

coronel_loess <- function(data, x, y) {
  ggplot(data, aes(get(x), get(y), group = crop)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = "loess", se = F) +
  facet_wrap(~ crop, scales = "free") +
      geom_blank(aes(y = 0))
}

```

# 01 A - Reading Static Data Sources

Here we import all the data previously downloaded by hand.
Last updated: started updating on 02/22/2021
Purpose: Import raw files without modification
Input: all files in raw_data folder
Output: datasets in r_data/outputs_01_egc.rda

```{r importing_static}

#FRIS Irrigation

fris_irrigation <- read_csv("raw_data/fris_irrigation/fris_irrigation.csv")

# CTIC - CRM Tillage

sheets <- excel_sheets("raw_data/ctic_crm_tillage/ctic_crm_tillage.xlsx")

wb <- list()

for (i in 1:length(sheets)) {
  wb[[i]] <- read_excel("raw_data/ctic_crm_tillage/ctic_crm_tillage.xlsx", sheets[i])
}

names(wb) <- sheets

ctic_crm_tillage <- bind_rows(wb, .id = "year")

# CTIC - OpTis Tillage - not in use for NIR, probably for benchmarks - egc 04/06/2021

### NEW DATA AVAILABLE, NEED TO REVISE ###
#ctic_optis_tillage <- read_csv("raw_data/ctic_optis_tillage/ctic_optis_tillage.csv")

# ARMS Tillage

arms_tillage <- read_csv("raw_data/arms_tillage/arms_tillage.csv")

# ARMS Manure

sheets <- excel_sheets("raw_data/arms_manure/arms_manure.xlsx")

wb <- list()

for (i in 1:length(sheets)) {
  wb[[i]] <- read_excel("raw_data/arms_manure/arms_manure.xlsx", sheets[i])
}

names(wb) <- sheets

arms_manure <- bind_rows(wb, .id = "crop")

rm(wb)

# ERS Tillage - egc 04/05/2021
# deprecated - egc 05/14/2021
# ers_tillage <- readxl::read_excel(
#   "raw_data/ers_tillage_intensity/tillage intensity and conservation cropping supporting tables.xlsx",
#   sheet = 1, skip = 1)

# ERS Seed data - egc 04/06/2021

ers_seed_data <- readxl::read_excel("raw_data/ers_seed_data/ers_seed_data_all_crops.xlsx", sheet = 1)

# Soil Erosion Rates from the USDA National Statistician's Office

# Function to read all files
crop_files <- list.files(path = "raw_data/NRI17_Erosion", pattern = ".xlsx")

tmp3 <- data.frame()

for (i in 1:length(crop_files)) {
  
  tmp1 <- readxl::read_excel(paste0("raw_data/NRI17_Erosion/", crop_files[i]), sheet = 2, skip = 6)
  
  crop_sheet <- readxl::read_excel(paste0("raw_data/NRI17_Erosion/", crop_files[i]), sheet = 2, range = "A1:A2")
  
  crop_name <- word(crop_sheet$`2017 National Resources Inventory`, -1)
  
  tmp2 <- tmp1 %>% 
    filter(is.na(State) == F) %>% 
    select(1:3, 15:16) %>% 
    mutate(crop = crop_name) %>% 
    rename("state" = 1,
           "year" = 2,
           "acreage_thousands" = 3,
           "erosion_rate" = 4,
           "erosion_rate_error" = 5)
  
  tmp3 <- rbind(tmp3, tmp2)
}

# Keep National values only
tmp4 <- tmp3 %>%
  filter(state == "National")

NRI_soil_erosion <- tmp4

rm(tmp1, tmp2, tmp3, tmp4, crop_files, crop_name, crop_sheet)

# Reading crop residue area burned
# From EPA GHG inventory and sinks

area_burned <- read_csv("raw_data/EPA_residue_area_burned/EPA_area_burned.csv")

# Creating data frame for rice methane
# Data from Table 5-11: CH4 Emissions from Rice Cultivation (MMT CO2 Eq.), EPA GHG sinks and inventory report 2019
# Acreage from Table 5-13: Rice Area Harvested (1,000 Hectares)
# There are more emissions data points (2015:2019), but not new acreage to match those values unfortunately. Since we need to calculate a rate per acre, having the emissions value only does not help us since we need the denominator of acres. Allison also didn't want to use the planted acreage from NASS, since the EPA sinks report uses National Resources Inventory data.
# We will later calculate an emissions per acre factor to use for rice methane emissions
rice_methane_emissions <- data.frame(
  year = c(1990, 2005, 2015),
  crop = "Rice",
  MMT_CO2e = c(16, 18, 16.2),
  harvested_ha_thousands = c(1707, 1788, 1619)
)

# Reading egrid efficiency data over time
# Data were collected from eGRID reports, source file is listed in the dataset below
# These data will be used to adjust the CO2e emissions of irrigation, fertilizers, pesticides, and maybe potato storage
egrid_efficiency <- read_csv("raw_data/eGRID_efficiency/egrid_efficiency.csv")

# On 05/05/2021 we received new ERS tillage data
# We need to re-work the tillage data. The new data received takes precedence over all other data sets
ers_tillage_2021 <- read_excel("raw_data/ers_2021_tillage/national_table_043021.xlsx")

# Residue removal for wheat and barley
removal_residue <- read_csv("raw_data/residue_removal_wheat_barley/residue_removal.csv") %>% 
  select(-data_source)

# Creating a data frame for nitrogen production efficiency
# Starting blank data set
N_production_efficiency <- data.frame(
  year = 1980:2020
)

# Adding a linear function that results in 30% decrease from 1980 to 2020
N_production_efficiency <- N_production_efficiency %>% 
  mutate(value = 672.685 - (0.3183 * year))

# CO2 global intensity to adjust GHG emissions of P, K, and chemical production
# Creating blank data set
global_CO2_intensity <- data.frame(
  year = 1980:2020
)

years_with_data <- data.frame(
  year = c(1990, 2018),
  value = c(529, 475)
  )

global_CO2_intensity <- global_CO2_intensity %>% 
  left_join(years_with_data) %>% 
  # linearly interpolate between data points using zoo::na.approx
  mutate_all(zoo::na.approx, na.rm = F) %>% 
  # Fill up and down with the first or last values
  tidyr::fill(value, .direction = "down") %>% 
  tidyr::fill(value, .direction = "up")

# Global energy intensity
# Also to adjust energy use of P, K, and chemical production
global_energy_intensity <- read_csv("raw_data/IEA_global_energy_efficiency/IEA_global_energy_efficiency.csv")

# egc - 07/13/2021
# Here I import data from ERS to differentiate corn grain and corn silage
# Manure tons per acre for corn silage is much higher than for corn grain
ers_manure_corn_data <- readxl::read_excel("raw_data/ers_manure_corn/manure_use_in_corn.xlsx")

# Adjustment for irrigation power source
# Data extracted from FRIS Energy Expense for All Well Pumps and Other Irrigation Pumps by Type of Energy Used
# All data tables back to 1979 have a similar name as above
fris_irrigation_power_source <- read_csv("raw_data/fris_irrigation/irrigation_power_source.csv")
```

# 01 B - Running API Queries

For NASS data, we run API queries

```{r importing_queries}
# NASS land use with API queries

# Batch import for land use data, excluding potatoes
short_desc_land_use <- read_csv("data_references/short_desc_land_use.csv") %>% 
  pull(1)

# short_desc_land_use_excl_potatoes <- short_desc_land_use %>% 
#   filter(str_detect(short_desc, pattern = "POTATOES", negate = T)) %>% # potatoes is a vegetable, not a field crop
#   pull(1)

nass_lu_data_collector <- data.frame() # keep going here, egc - 05/19/2021

for (i in 1:length(short_desc_land_use)) {
  
  tmp1 <- nass_data(source_desc = "SURVEY",
                    sector_desc = "CROPS",
                    #group_desc = "FIELD CROPS",
                    short_desc = short_desc_land_use[i],
                    domain_desc = "TOTAL",
                    agg_level_desc = "NATIONAL",
                    year = ">=1980",
                    reference_period_desc = "YEAR"
                    )
  
  nass_lu_data_collector <- rbind(nass_lu_data_collector, tmp1)
  
  print(paste(i, "out of", length(short_desc_land_use)))
  print(short_desc_land_use[i])
  Sys.sleep(0.5)
}

# Batch import for potatoes
# short_desc_potatoes <- short_desc_land_use %>% 
#   filter(str_detect(short_desc, pattern = "POTATOES")) %>% # potatoes is a vegetable, not field crop
#   pull(1)
# 
# data_collector_potatoes <- data.frame()
# 
# for (i in 1:length(short_desc_potatoes)) {
#   
#   tmp1 <- nass_data(source_desc = "SURVEY",
#                     sector_desc = "CROPS",
#                     group_desc = "VEGETABLES",
#                     short_desc = short_desc_potatoes[i],
#                     domain_desc = "TOTAL",
#                     agg_level_desc = "NATIONAL",
#                     year = ">=1980",
#                     reference_period_desc = "YEAR"
#                     )
#   
#   data_collector_potatoes <- rbind(data_collector_potatoes, tmp1)
#   
#   print(paste(i, "out of", length(short_desc_potatoes)))
#   print(short_desc_potatoes[i])
#   Sys.sleep(0.5)
# }

# Batch import for sucrose percent in sugar beets
sugarbeets_sucrose_pct <- nass_data(source_desc = "SURVEY",
          sector_desc = "CROPS",
          group_desc = "FIELD CROPS",
          short_desc = "SUGARBEETS - SUCROSE, MEASURED IN PCT",
          domain_desc = "TOTAL",
          #agg_level_desc = "NATIONAL",
          year = ">=1980",
          reference_period_desc = "YEAR"
          )

# Binding data
nass_land_use <- nass_lu_data_collector %>% 
  mutate(Value = as.numeric(str_remove_all(string = Value, pattern = ",")),
         year = as.numeric(year)) %>% 
  select(year, commodity_desc, short_desc, Value) %>% 
  rename(Year = year,
         Commodity = commodity_desc,
         `Data Item` = short_desc)

rm(nass_lu_data_collector, short_desc_land_use, tmp1)

# NASS Chemicals with API queries

short_desc_environmental <- read_csv("data_references/short_desc_environmental.csv") %>% 
  pull(1)

# short_desc_environmental_excl_potatoes <- short_desc_environmental %>% 
#   filter(!str_detect(short_desc, pattern = "POTATOES")) %>% 
#   pull(1)

# all crops except potatoes
environ_collector <- data.frame()

for (i in 1:length(short_desc_environmental)) {
  
  tmp1 <- nass_data(source_desc = "SURVEY",
                    sector_desc = "ENVIRONMENTAL",
                    #group_desc = "FIELD CROPS",
                    short_desc = short_desc_environmental[i],
                    agg_level_desc = "REGION : MULTI-STATE",
                    year = ">=1980"
                    )
  
  environ_collector <- rbind(environ_collector, tmp1)
  
  print(paste(i, "out of", length(short_desc_environmental)))
  print(short_desc_environmental[i])
  Sys.sleep(0.5)
}

# for potatoes, since it's a vegetable

# short_desc_environmental_potatoes <- short_desc_environmental %>% 
#   filter(str_detect(short_desc, pattern = "POTATOES")) %>% 
#   pull(1)

# environ_potatoes <- nass_data(source_desc = "SURVEY",
#                               sector_desc = "ENVIRONMENTAL",
#                               group_desc = "VEGETABLES",
#                               short_desc = short_desc_environmental_potatoes,
#                               agg_level_desc = "REGION : MULTI-STATE",
#                               year = ">=1980"
#                               )

nass_chemicals <- environ_collector %>%
  #bind_rows(environ_potatoes) %>% 
  select(year, commodity_desc, short_desc, domain_desc, domaincat_desc, Value) %>% 
  rename(Year = year,
         Commodity = commodity_desc,
         `Data Item` = short_desc,
         Domain = domain_desc,
         `Domain Category` = domaincat_desc) %>% 
  mutate(Value = as.numeric(str_remove_all(string = Value, pattern = ",")),
         Year = as.numeric(Year))

# Number of passes for application energy and GHG emissions
num_passes_vector <- read_csv("data_references/num_passes_short_desc.csv") %>% pull(descriptions)

nass_num_passes <- data.frame()

for (i in 1:length(num_passes_vector)) {
  
  tmp1 <-  nass_data(source_desc = "SURVEY",
                     sector_desc = "ENVIRONMENTAL",
                     #group_desc = "VEGETABLES", # "FIELD CROPS"
                     short_desc = num_passes_vector[i],
                     agg_level_desc = "REGION : MULTI-STATE",
                     year = ">=1980"
  )
  
  nass_num_passes <- rbind(nass_num_passes, tmp1)
  
  print(paste(i, "out of", length(num_passes_vector)))
  print(num_passes_vector[i])
  Sys.sleep(0.5)
}

rm(environ_collector, short_desc_environmental, tmp1,
   i, num_passes_vector, sheets)
```

# 01 Save 01 Output

```{r saving_output_01}
save(nass_land_use,
     nass_chemicals,
     fris_irrigation,
     ctic_crm_tillage,
     #ctic_optis_tillage, - we won't be using OPTIS for the NIR - egc 04/06/2021
     arms_manure,
     arms_tillage,
     #ers_tillage, egc - deprecated 05/14/2021
     ers_seed_data,
     NRI_soil_erosion,
     area_burned,
     rice_methane_emissions,
     sugarbeets_sucrose_pct,
     egrid_efficiency,
     ers_tillage_2021,
     removal_residue,
     nass_num_passes,
     N_production_efficiency,
     global_CO2_intensity,
     global_energy_intensity,
     ers_manure_corn_data,
     fris_irrigation_power_source,
     file = "r_data/outputs_01_egc.rda")
```

# 02 Clean, Substitute, Combine, Other Important Actions

Last updated: 8/2/2019 (Kathy Xiong) - starting on 02/22/2021 (Eric Coronel)
Purpose: Create a master dataset with one row per crop-year & all variables in columns
Input: datasets in r_data/outputs_01.rda
Output: master dataset in r_data/outputs_02.rda

## 02 Load 01 Data If Needed
```{r load_outputs_01_egc}
load("r_data/outputs_01_egc.rda")
```

## 02 Cleaning NASS Land Use
```{r clean_NASS_land_use}

# NASS land use
nass_land_use_2 <- nass_land_use %>% 
  rename_all(tolower) %>% 
  select(-commodity) %>% 
  separate(`data item`, c("crop", "data_item"), sep = " - ")

# convert cotton production to lbs (from 480 lb bales)
# convert rice yield to cwt (from lbs)
nass_land_use_3 <- nass_land_use_2 %>% 
  mutate(
    value_2 = case_when(
      crop == "COTTON" & data_item == "PRODUCTION, MEASURED IN 480 LB BALES" ~ value * 480,
      crop == "RICE" & data_item == "YIELD, MEASURED IN LB / ACRE" ~ value / 100, 
      TRUE ~ value
      ),
    data_item_2 = case_when(
      crop == "COTTON" & data_item == "PRODUCTION, MEASURED IN 480 LB BALES" ~ "PRODUCTION, MEASURED IN LB",
      crop == "RICE" & data_item == "YIELD, MEASURED IN LB / ACRE" ~ "YIELD, MEASURED IN CWT / ACRE",
      TRUE ~ data_item
      )
    )

# reshape dataset
nass_land_use_4 <- nass_land_use_3 %>% 
  select(-data_item, -value) %>% 
  rename(data_item = data_item_2,
         value = value_2) %>% 
  separate(data_item, c("data_item_short", "unit"), sep = ", ") %>% 
  mutate(data_item_short = str_to_lower(data_item_short) %>% str_replace_all(" ", "_")) %>% 
  select(-unit) %>% 
  spread(data_item_short, value)

# CORN: estimate acres planted for grain and silage
# based on acres planted for crop overall, by assuming
# equal loss ratio for grain and silage
corn_harvested <- nass_land_use_4 %>% 
  filter(crop %in% c("CORN, GRAIN", "CORN, SILAGE")) %>% 
  separate(crop, c("crop", "grain_or_silage"), sep = ", ") %>% 
  group_by(year, crop) %>% 
  summarise(acres_harvested = sum(acres_harvested))

corn_planted <- nass_land_use_4 %>% 
  filter(crop == "CORN") %>% 
  select(year, crop, acres_planted)

corn <- corn_harvested %>%
  left_join(corn_planted, by = c("year", "crop")) %>% 
  mutate(pct_harvested = acres_harvested / acres_planted) %>% 
  select(year, crop, pct_harvested)

d <- list(
  crop = c("CORN, GRAIN", "CORN, SILAGE"),
  year = seq(1980, 2020, by = 1) # error discovered here, the seq went up to 2018. egc - 04/21/2021
)

d <- cross_df(d) %>% 
  separate(crop, c("crop_main", "grain_or_silage"), sep = ", ", remove = FALSE)

corn_2 <- d %>% 
  left_join(corn, by = c("year", "crop_main" = "crop")) %>% 
  select(year, crop, pct_harvested)

nass_land_use_5 <- nass_land_use_4 %>% 
  left_join(corn_2, by = c("year", "crop")) %>% 
  filter(crop != "CORN") %>% 
  mutate(acres_planted = ifelse(crop %in% c("CORN, GRAIN", "CORN, SILAGE"),
                                acres_harvested / pct_harvested,
                                acres_planted)) %>% 
  select(-pct_harvested) %>% 
  mutate(crop = str_to_sentence(crop))

# ratio of corn grain to corn silage, for use later
corn_pct <- nass_land_use_5 %>% 
  filter(crop %in% c("Corn, grain", "Corn, silage")) %>% 
  select(year, crop, acres_planted) %>% 
  group_by(year) %>% 
  mutate(pct_corn_acres = acres_planted / sum(acres_planted)) %>% 
  select(year, crop, pct_corn_acres)

# egc 02/24/2021: I am replacing Kathy's sorghum processing with the same processing as corn grain and silage. We then discard sorghum silage since it's not a Field to Market crop

# sorghum: estimate acres planted for grain and silage
# based on acres planted for crop overall, by assuming
# equal loss ratio for grain and silage

sorghum_harvested <- nass_land_use_4 %>% 
  filter(crop %in% c("SORGHUM, GRAIN", "SORGHUM, SILAGE")) %>% 
  separate(crop, c("crop", "grain_or_silage"), sep = ", ") %>% 
  group_by(year, crop) %>% 
  summarise(acres_harvested = sum(acres_harvested))

sorghum_planted <- nass_land_use_4 %>% 
  filter(crop == "SORGHUM") %>% 
  select(year, crop, acres_planted)

sorghum_egc <- sorghum_harvested %>%
  left_join(sorghum_planted, by = c("year", "crop")) %>% 
  mutate(pct_harvested = acres_harvested / acres_planted) %>% 
  select(year, crop, pct_harvested)

d <- list(
  crop = c("SORGHUM, GRAIN", "SORGHUM, SILAGE"),
  year = seq(1980, 2020, by = 1)
)

d <- cross_df(d) %>% 
  separate(crop, c("crop_main", "grain_or_silage"), sep = ", ", remove = FALSE)

sorghum_2_egc <- d %>% 
  left_join(sorghum_egc, by = c("year", "crop_main" = "crop")) %>% 
  select(year, crop, pct_harvested) %>% 
  mutate(crop = str_to_sentence(crop))

nass_land_use_6 <- nass_land_use_5 %>% 
  left_join(sorghum_2_egc, by = c("year", "crop")) %>% 
  filter(crop != "Sorghum") %>% 
  mutate(acres_planted = ifelse(crop %in% c("Sorghum, grain", "Sorghum, silage"),
                                acres_harvested / pct_harvested,
                                acres_planted)) %>% 
  select(-pct_harvested) %>% 
  mutate(crop = str_to_sentence(crop))

# ratio of sorghum grain to sorghum silage, for use later, egc (maybe, let's see)
sorghum_pct <- nass_land_use_6 %>% 
  filter(crop %in% c("Sorghum, grain", "Sorghum, silage")) %>% 
  select(year, crop, acres_planted) %>% 
  group_by(year) %>% 
  mutate(pct_sorghum_acres = acres_planted / sum(acres_planted)) %>% 
  select(year, crop, pct_sorghum_acres)

# Clean sugar beets sucrose content, this will be used when creating output 02
sugarbeets_sucrose_pct_2 <- sugarbeets_sucrose_pct %>% 
  mutate(year = as.numeric(year),
         Value = as.numeric(Value)) %>% 
  group_by(year) %>% 
  summarize(sucrose_pct = round(mean(Value), 1)) %>% 
  mutate(crop = "Sugar beets")

# save final version
nass_land_use_final <- nass_land_use_6 %>% 
  filter(!(crop %in% c("Wheat, spring, (excl durum)", "Wheat, spring, durum", "Wheat, winter",
                       "Sorghum, silage"))) %>% # egc - 03/18 remove crops for which we have no further use
  mutate(crop = ifelse(test = crop == "Sorghum, grain", # rename to be consistent with other datasets
                       yes = "Sorghum",
                       no = crop)) %>% 
  mutate(crop = ifelse(test = crop == "Sugarbeets", # rename to be consistent with other datasets
                       yes = "Sugar beets",
                       no = crop))
```

## 02 Clean NASS Chemicals

```{r clean_NASS_chemicals}
# NASS chemicals

# what I see I need to do
# Separate chemical data into fertilizer and chemicals
# Fertilizer processing is the same, but with the removal of sulfur data
# Separate into data < 1994 and data >= 1994
# Separate chemical data into fungicide + herbicide + insecticide and OTHER
# For data < 1994
# Add ref table to partition the chemical, others appropriately, will need new columns
# Sum up data together by chemical category - there will be no Other category, we only keep the categories for which we have multiplication factors
# For data >= 1994
# We add ref table data to again be able to distribute CHEMICAL, OTHER data into appropriate categories
# Then we add these new totals into the respective total category (herbicide, fumigant, etc). There will be no Other category but we'll have new ones (fumigants, growth regulators)

# Import updated ref table
ref_table_pest <- read_csv("data_references/pesticide_codes.csv")

# Fertilizer data
fertilizers_all_years <- nass_chemicals %>% 
  filter(Domain == "FERTILIZER") %>% 
  filter(`Domain Category` != "FERTILIZER: (SULFUR)") %>% 
  select(-c(`Data Item`, Domain)) %>% 
  rename(Domain = `Domain Category`) # This is ready

# Chemicals < 1994
chemicals_before_1994 <- nass_chemicals %>% 
  filter(Domain != "FERTILIZER") %>% 
  filter(Year < 1994) %>% 
  # Separate to get chemical codes added via a left join
  mutate(`Domain Category` = str_remove_all(`Domain Category`, "\\(|\\)")) %>% 
  separate(`Domain Category`, into = c("ai", "code"), sep = " = ") %>% 
  mutate(code = as.numeric(code)) %>% 
  left_join(ref_table_pest, by = "code") %>% 
  mutate(type_edited = paste("CHEMICAL,", toupper(type))) %>% 
  mutate(Domain = ifelse(test = Domain == "CHEMICAL, OTHER",
                                yes = type_edited,
                                no = Domain)) %>% 
  group_by(Year, Commodity, Domain) %>% 
  summarize(Value = sum(Value)) # This is ready

# Chemicals >= 1994
# Excludes CHEMICAL, OTHER
chemicals_after_1994_totals_only <- nass_chemicals %>% 
  filter(Domain != "FERTILIZER") %>% 
  filter(Year >= 1994) %>% 
  filter(str_detect(`Domain Category`, "TOTAL")) %>% 
  filter(Domain != "CHEMICAL, OTHER")

chemicals_after_1994_others_only <- nass_chemicals %>% 
  filter(Domain != "FERTILIZER") %>% 
  filter(Year >= 1994) %>% 
  filter(Domain == "CHEMICAL, OTHER") %>% 
  filter(`Domain Category` != "CHEMICAL, OTHER: (TOTAL)") %>% 
  filter(!is.na(Value)) %>% 
  mutate(`Domain Category` = str_remove_all(`Domain Category`, "\\(|\\)")) %>% 
  separate(`Domain Category`, into = c("ai", "code"), sep = " = ") %>% 
  mutate(code = as.numeric(code)) %>% 
  left_join(ref_table_pest, by = "code") %>% 
  ungroup() %>% 
  group_by(Year, Commodity, type) %>% 
  summarize(Value = sum(Value)) %>% 
  filter(type %in% c("Fumigant", "Fungicide", "Herbicide", "Growth Reg")) 

# manual replacements
# potatoes 1996 gets 43869000 lbs of fumigants
# peanuts 2013 gets 1/3 of Fumigant, Fungicide, Growth Reg for 1303000 lbs
# wheat 2015 gets 29000 lbs of 2015 divided as Fungicide 0.4, Growth Reg 0.2, Herbicide 0.4
# for source data check "sleuthing_chemicals_others.R" in primitives folder
# It's to make up for unaccounted chemical others
additional_chem_other_data <- data.frame(
  Year = c(1996, 2013, 2013, 2013, 2015, 2015, 2015),
  Commodity = c("POTATOES", "PEANUTS", "PEANUTS", "PEANUTS", "WHEAT", "WHEAT", "WHEAT"),
  type = c("Fumigant", "Fumigant", "Fungicide", "Growth Reg", "Fungicide", "Growth Reg", "Herbicide"),
  Value = c(43869000, (0.33 * 1303000), (0.33 * 1303000), (0.33 * 1303000), 
                (0.4 * 29000), (0.2 * 29000), (0.4 * 29000))
)

chemicals_after_1994_others_only_with_addition <- chemicals_after_1994_others_only %>% 
  bind_rows(additional_chem_other_data) %>% 
  arrange(Year, Commodity) %>% 
  mutate(Domain = paste("CHEMICAL,", toupper(type))) %>% 
  select(Year, Commodity, Domain, Value)

# I now need to add chemicals_after_1994_others_only_with_addition to the >1994 dataset 
# Also add the data before 1994 and the fertilizer data
# and do one more sum by category, plus some cosmetics probably
chem_processing <- chemicals_after_1994_totals_only %>% 
  select(-c(`Data Item`, `Domain Category`)) %>% 
  bind_rows(chemicals_after_1994_others_only_with_addition) %>% 
  bind_rows(chemicals_before_1994) %>%
  bind_rows(fertilizers_all_years) %>% 
  ungroup() %>% 
  group_by(Year, Commodity, Domain) %>% 
  summarize(Value = sum(Value)) %>%
  arrange(Year, Commodity)

# select variables
nass_chemicals_2 <- chem_processing %>% 
  rename(crop = Commodity) %>% 
  rename_all(tolower) %>% 
  #separate(`data item`, c("crop", "item_orig"), sep = " - ") %>% 
  #filter(item_orig == "APPLICATIONS, MEASURED IN LB") %>% 
  mutate(#value = as.numeric(str_remove_all(value, ",")),
         item = case_when(domain == "CHEMICAL, FUNGICIDE" ~ "chemical_fungicide",
                          domain == "CHEMICAL, HERBICIDE" ~ "chemical_herbicide",
                          domain == "CHEMICAL, INSECTICIDE" ~ "chemical_insecticide",
                          domain == "CHEMICAL, FUMIGANT" ~ "chemical_fumigant",
                          domain == "CHEMICAL, GROWTH REG" ~ "chemical_growth_reg",
                          domain == "FERTILIZER: (NITROGEN)" ~ "fertilizer_nitrogen",
                          domain == "FERTILIZER: (PHOSPHATE)" ~ "fertilizer_phosphate",
                          domain == "FERTILIZER: (POTASH)" ~ "fertilizer_potash"
                          )) %>% 
  #filter(!is.na(item)) %>% 
  mutate(crop = str_to_sentence(crop) %>% str_replace("_", ", "))

# reshape & sum by major crop
nass_chemicals_3 <- nass_chemicals_2 %>% 
  select(year, crop, item, value) %>% 
  spread(key = "item", value = "value") %>% 
  mutate(crop = case_when(#crop == "Potatoes, fall" ~ "Potatoes",
                          #crop == "Wheat, spring, (excl durum)" ~ "Wheat",
                          #crop == "Wheat, spring, durum" ~ "Wheat",
                          #crop == "Wheat, winter" ~ "Wheat",
                          #crop == "Wheat, post harvest" ~ "Wheat", # only shows up in 2009 - delete?
                          crop == "Sugarbeets" ~ "Sugar beets",
                          TRUE ~ crop)) #%>% 
  #group_by(year, crop) %>% 
  #summarise_all(sum, na.rm = TRUE)

# assume same chemical use rate for corn grain and corn silage
corn_grain <- nass_chemicals_3 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, grain")

corn_silage <- nass_chemicals_3 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, silage")

corn <- bind_rows(corn_grain, corn_silage) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(corn_pct, by = c("year", "crop")) %>% 
  mutate_at(vars(-year, -crop), list(~ . * pct_corn_acres)) %>% 
  select(-pct_corn_acres)

nass_chemicals_4 <- nass_chemicals_3 %>% 
  ungroup() %>% 
  filter(crop != "Corn") %>% 
  mutate(year = as.numeric(year)) %>% 
  bind_rows(corn)

nass_chemicals_final <- nass_chemicals_4

#rm()
```

## 02 Clean FRIS Irrigation

```{r clean_FRIS}
# FRIS Irrigation
# egc 03/17/2021

# Here I am first adding data imputation methodology for the 2018 data, since it's missing non-irrigated yield and acreage
# Calculate ratios for yield and acreage (non-irrigated / irrigated)
ratio_test <- fris_irrigation %>% 
  mutate(ratio_yield = yield_non_irrigated/yield_irrigated,
         ratio_acreage = acres_non_irrigated/acres_irrigated)

ratio_last_four_samplings <- ratio_test %>% 
  filter(year != 2018) %>% # 2018 is the sampling without non-irrigated data
  arrange(crop, year) %>% 
  group_by(crop) %>% 
  slice(tail(row_number(), 4))

ratio_avgs <- ratio_last_four_samplings %>% 
  group_by(crop) %>% 
  summarize(avg_yield_ratio = mean(ratio_yield, na.rm = T),
            avg_acreage_ratio = mean(ratio_acreage, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(year = 2018)

fris_irrigation <- fris_irrigation %>% 
  left_join(ratio_avgs, by = c("crop", "year")) %>% 
  mutate(acres_non_irrigated = ifelse(test = year == 2018,
                                      yes = acres_irrigated * avg_acreage_ratio,
                                      no = acres_non_irrigated),
         yield_non_irrigated = ifelse(test = year == 2018,
                                      yes = yield_irrigated * avg_yield_ratio,
                                      no = yield_non_irrigated)) %>% 
  select(-c(avg_yield_ratio, avg_acreage_ratio)) %>% 
  mutate(acres_non_irrigated = round(acres_non_irrigated, 0),
         yield_non_irrigated = round(yield_non_irrigated, 0))

# rename crops
fris_irrigation_2 <- fris_irrigation %>% 
  mutate(crop = str_to_sentence(crop),
         crop = case_when(crop == "Sorghum, grain" ~ "Sorghum",
                          crop == "Wheat, grain" ~ "Wheat",
                          crop == "Barley, grain" ~ "Barley",
                          crop == "Sugarbeets" ~ "Sugar beets",
                          TRUE ~ crop)) %>% 
  # Remove unused variable
  select(-acre_wells_all_crops)

# save final version
fris_irrigation_final <- fris_irrigation_2
```

## 02 Clean CTIC CRM Tillage

```{r clean_CRM_tillage}

# CTIC - CRM Tillage
# Soybeans and cotton are 0 for all data in 2002, this will permit to do interpolation by year/crop in the next step
ctic_crm_tillage[ctic_crm_tillage == 0] <- NA

# select & rename crops
ctic_crm_tillage_2 <- ctic_crm_tillage %>% 
  filter(crop %in% c("Corn", 
                     "Soybeans (FS)",
                     "Soybeans (DC)",
                     "Cotton",
                     "Spring Wheat",
                     "Winter Wheat",
                     "Grain Sorghum",
                     "Grain Sorghum (FS)",
                     "Barley",
                     "Peanuts",
                     "Potatoes",
                     "Rice",
                     "Sugar Beets",
                     "Corn (FS)")) %>% 
  group_by(crop) %>% 
  arrange(year) %>% 
  mutate_all(zoo::na.approx, na.rm = FALSE) %>% # egc added 03/19, interpolates soybeans and cotton missing 2002 survey
  ungroup() %>% # egc added 03/19
  mutate(crop = case_when(crop == "Soybeans (FS)" ~ "Soybeans", # Soybean acres includes FS (Full-season) and DC (double-crop)
                          crop == "Soybeans (DC)" ~ "Soybeans", # Soybean acres includes FS (Full-season) and DC (double-crop)
                          crop == "Spring Wheat" ~ "Wheat", # Wheat acres includes spring and winter wheat
                          crop == "Winter Wheat" ~ "Wheat", # Wheat acres includes spring and winter wheat
                          crop == "Grain Sorghum" ~ "Sorghum",
                          crop == "Grain Sorghum (FS)" ~ "Sorghum",
                          crop == "Sugar Beets" ~ "Sugar beets",
                          crop == "Corn (FS)" ~ "Corn",
                          TRUE ~ crop
  )) %>% 
  group_by(year, crop) %>% 
  summarise_all(sum, na.rm = TRUE) %>% 
  mutate_at(vars(-year, -crop, -total_acres), list(~ ./total_acres)) # calculate tillage type as pct of planted acres

# rename variables
ctic_crm_tillage_3 <- ctic_crm_tillage_2 %>% 
  setNames(paste0('ctic_crm_', names(.))) %>% 
  ungroup() %>% 
  rename(year = ctic_crm_year,
         crop = ctic_crm_crop,
         ctic_crm_planted_acres = ctic_crm_total_acres)

# assume same tillage pct for corn grain and corn silage
corn_grain <- ctic_crm_tillage_3 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, grain")

corn_silage <- ctic_crm_tillage_3 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, silage")

corn <- bind_rows(corn_grain, corn_silage) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(corn_pct, by = c("year", "crop")) %>% 
  mutate(ctic_crm_planted_acres = ctic_crm_planted_acres * pct_corn_acres) %>% 
  select(-pct_corn_acres)

ctic_crm_tillage_4 <- ctic_crm_tillage_3 %>%
  filter(crop != "Corn") %>% 
  mutate(year = as.numeric(year)) %>% 
  bind_rows(corn) %>% 
  # egc 04/01 - summing up together reduced tillage, ridge till, mulch till
  mutate(ctic_crm_reduced_till = ctic_crm_conservation_ridge_till + ctic_crm_conservation_mulch_till +
           ctic_crm_reduced_till) %>% 
  select(-c(ctic_crm_planted_acres, ctic_crm_conservation_ridge_till, ctic_crm_conservation_mulch_till, ctic_crm_conservation_till_total))

# save final version
ctic_crm_tillage_final <- ctic_crm_tillage_4
```

## 02 Clean CTIC OPTIS Data

```{r clean_optis}
# Placeholder here, not using the data so far
# CTIC - OpTis Tillage
### NEW DATA AVAILABLE, NEED TO REVISE ###
# egc note 03/19, these data are only corn/soybeans for the I states...
# Not for National Indicators Report - egc 04/06/2021
#ctic_optis_tillage$crop %>% unique()

# select crops
#ctic_optis_tillage_2 <- ctic_optis_tillage %>% 
#  filter(crop %in% c("Corn", "Soybeans"))

# save final version
# ctic_optis_tillage_final <- ctic_optis_tillage_2
```

## 02 Clean ARMS Tillage

```{r clean_ARMS_tillage}
# ARMS Tillage
# select & rename final crops
arms_tillage_2 <- arms_tillage %>% 
  filter(crop %in% c("Corn", 
                     "Soybeans",
                     "Cotton",
                     "Spring Wheat",
                     "Winter Wheat",
                     "Durum Wheat",
                     "Barley",
                     "Peanuts",
                     "Rice")) %>% 
  mutate(crop = case_when(crop == "Spring Wheat" ~ "Wheat", # Wheat acres includes spring, winter, and durum wheat
                          crop == "Winter Wheat" ~ "Wheat", # Wheat acres includes spring, winter, and durum wheat
                          crop == "Durum Wheat" ~ "Wheat",  # Wheat acres includes spring, winter, and durum wheat
                          TRUE ~ crop
  )) %>% 
  group_by(year, crop) %>% 
  summarise_all(sum, na.rm = TRUE) %>% 
  mutate_at(vars(-year, -crop, -total_acres), list(~ ./total_acres)) %>% # tillage type as pct of planted acres
  # egc 04/01/2021 aggregating for reduced till and removing unnecessary variables
  mutate(reduced_till = ridge_till + mulch_till + reduced_till) %>%
  select(-c(mulch_till, ridge_till, unknown_till))

# rename variables
arms_tillage_3 <- arms_tillage_2 %>% 
  setNames(paste0('arms_', names(.))) %>% 
  ungroup() %>% 
  rename(year = arms_year,
         crop = arms_crop,
         arms_planted_acres = arms_total_acres)

# assume same tillage pct for corn grain and corn silage
corn_grain <- arms_tillage_3 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, grain")

corn_silage <- arms_tillage_3 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, silage")

corn <- bind_rows(corn_grain, corn_silage) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(corn_pct, by = c("year", "crop")) %>% 
  mutate(arms_planted_acres = arms_planted_acres * pct_corn_acres) %>% 
  select(-pct_corn_acres)

arms_tillage_4 <- arms_tillage_3 %>% 
  filter(crop != "Corn") %>% 
  mutate(year = as.numeric(year)) %>% 
  bind_rows(corn) %>% 
  select(-arms_planted_acres)

arms_tillage_4[arms_tillage_4 == 0] <- NA

# save final version
arms_tillage_final <- arms_tillage_4
```

## 02 Clean ARMS Manure

```{r clean_ARMS_manure}

# ARMS Manure

# select variables
arms_manure_2 <- arms_manure %>% 
  rename(item = `...1`, unit = `...2`) %>% 
  filter(item %in% c("Planted acres", "Treated with manure", "Tons Applied")) %>%
  gather(key = "year", value = "value", -crop, -item, -unit)

# rename variables & reshape dataset
arms_manure_3 <- arms_manure_2 %>% 
  select(-unit) %>% 
  mutate(value = str_remove(value, "\\*"),
         value = as.numeric(value)) %>%  
  spread(key = "item", value = "value") %>% 
  rename(manure_planted_acres = `Planted acres`,
         manure_pct_treated = `Treated with manure`,
         manure_tons_per_acre = `Tons Applied`) %>% 
  filter_at(vars(-crop, -year), any_vars(!is.na(.))) %>% 
  mutate(crop = str_to_sentence(crop))

# Renaming crops, we can add values for categories of barley (malt vs. feed) and wheat (spring, winter, and durum)
# and get an overall value for barley and wheat
# What we need:
# Manure tons per acre
# Share of acreage treated with manure
# Nitrogen content from that manure app (assumed value)

arms_manure_4 <- arms_manure_3 %>% 
  # Combining types for barley and wheat
  mutate(crop = case_when(crop == "Barley_feed" ~ "Barley",
                          crop == "Barley_malt" ~ "Barley",
                          crop == "Durum_wheat" ~ "Wheat",
                          crop == "Spring_wheat" ~ "Wheat",
                          crop == "Winter_wheat" ~ "Wheat",
                          TRUE ~ crop)) %>% 
  group_by(year, crop) %>% 
  # Here we aggregate the barley and wheat values
  summarize(manure_planted_acres = sum(manure_planted_acres, na.rm = TRUE),
            manure_tons_per_acre = mean(manure_tons_per_acre, na.rm = TRUE),
            manure_pct_treated = mean(manure_pct_treated, na.rm = TRUE))

# Documenting how we calculate the manure nitrogen content
# weighting based on ARMS corn 2010 manure table data, not perfect but couldn't find national info on this
# source of nutrient content http://omafra.gov.on.ca/english/crops/facts/13-043.htm
manure_nitrogen_content <- data.frame(
  animal = c("beef", "dairy", "pork", "poultry"),
  n_pct = c(0.37, 0.39, 0.39, 0.81),
  weight = c(0.22, 0.42, 0.24, 0.12)) %>% 
  mutate(value = n_pct * weight) %>% 
  summarize(weighted_average = sum(value/100)) %>% 
  pull(weighted_average)

# Here we calculate the rate for all acreage and the N lb/acre from manure
arms_manure_5 <- arms_manure_4 %>%
  mutate(year = as.numeric(year)) %>% 
  bind_rows(ers_manure_corn_data) %>% # bringing the new corn grain/silage data from ERS
  mutate(manure_planted_acres = manure_planted_acres * 1000, # to get acreage in millions
    manure_total_tons = manure_tons_per_acre * (manure_planted_acres * (manure_pct_treated / 100)),
    manure_rate_all_acreage = manure_total_tons / manure_planted_acres, # effective manure rate
    manure_N_lbs_per_acre = manure_rate_all_acreage * 2000 * manure_nitrogen_content) # 2000 to convert ton to lb

# Empty data points
arms_manure_5[arms_manure_5 == "NaN"] <- NA

arms_manure_6 <- arms_manure_5 %>% 
  filter(!is.na(manure_tons_per_acre))

# Duplicating data for corn grain and silage
# assume same tillage pct for corn grain and corn silage
# corn_grain <- arms_manure_6 %>% 
#   filter(crop == "Corn") %>% 
#   mutate(crop = "Corn, grain")
# 
# corn_silage <- arms_manure_6 %>% 
#   filter(crop == "Corn") %>% 
#   mutate(crop = "Corn, silage")
# 
# corn <- bind_rows(corn_grain, corn_silage) %>% 
#   ungroup()
  # If we know of a better method to adjust corn grain and silage, it should be done below
  #mutate(year = as.numeric(year)) %>% 
  #left_join(corn_pct, by = c("year", "crop")) %>% 
  #mutate(
  #       manure_total_tons = manure_total_tons * pct_corn_acres) %>% 
  # mutate(manure_planted_acres = manure_planted_acres * pct_corn_acres,
  #        manure_total_tons = manure_tons_per_acre * (manure_planted_acres * (manure_pct_treated / 100)),
  #        manure_rate_all_acreage = manure_total_tons / manure_planted_acres,
  #        manure_N_lbs_per_acre = manure_rate_all_acreage * 2000 * 0.75/100) %>% 
  # select(-pct_corn_acres)

arms_manure_7 <- arms_manure_6 %>% 
  ungroup() %>% 
  filter(crop != "Corn") %>% 
  # bringing the corn grain and silage data
  #bind_rows(corn) %>%
  # selecting only variables of interest
  select(1:2, 7:8)

# save final version
arms_manure_final <- arms_manure_7 %>% 
  arrange(year, crop)

# The code below is primitive - egc 04/08/2021
# ARMS Manure
# 
# # select variables
# arms_manure_2 <- arms_manure %>% 
#   rename(item = `...1`, unit = `...2`) %>% 
#   filter(item %in% c("Planted acres", "Treated with manure", "Tons Applied") |
#          unit %in% c("Manure State Pct of Treated Acres", "Manure Type Pct of Treated Acres")) %>% 
#   gather(key = "year", value = "value", -crop, -item, -unit)
# 
# # rename variables & reshape dataset
# arms_manure_3 <- arms_manure_2 %>% 
#   select(-unit) %>% 
#   mutate(value = str_remove(value, "\\*"),
#          value = as.numeric(value)) %>%  
#   spread(key = "item", value = "value") %>% 
#   rename(manure_planted_acres = `Planted acres`,
#          manure_pct_treated = `Treated with manure`,
#          manure_tons_per_acre = `Tons Applied`,
#          manure_beef = `Beef cattle`,
#          manure_dairy = `Dairy cattle`,
#          manure_hog = `Hogs`,
#          manure_poultry = `Poultry`,
#          manure_other = `Other`,
#          manure_slurry = `Slurry Liquid`,
#          manure_dry = `Semi-dry or Dry`,
#          manure_lagoon = `Lagoon liquid`) %>% 
#   filter_at(vars(-crop, -year), any_vars(!is.na(.))) %>% 
#   mutate(crop = str_to_sentence(crop))
# 
# # calculate tons of manure applied by type and state
# # based on share of manure applied by type and state
# # this way we can add up values for sub-categories of barley (malt vs. feed) and wheat (spring, winter, and durum)
# # and get an overall value for barley and wheat
# 
# arms_manure_4 <- arms_manure_3 %>% 
#   mutate(manure_total_tons = manure_tons_per_acre * (manure_planted_acres * manure_pct_treated / 100)) %>% 
#   mutate_at(vars(manure_beef, manure_dairy, manure_hog, manure_poultry, manure_other,
#                  manure_slurry, manure_dry, manure_lagoon), # calculate manure type as pct of total manure
#             list(~ manure_total_tons * ./100)) %>% 
#   mutate(crop = case_when(crop == "Barley_feed" ~ "Barley",
#                           crop == "Barley_malt" ~ "Barley",
#                           crop == "Durum_wheat" ~ "Wheat",
#                           crop == "Spring_wheat" ~ "Wheat",
#                           crop == "Winter_wheat" ~ "Wheat",
#                           TRUE ~ crop)) %>% 
#   group_by(year, crop) %>% 
#   summarise_at(vars(-manure_pct_treated, -manure_tons_per_acre), sum, na.rm = TRUE) %>% 
#   filter(manure_total_tons > 0) %>% 
#   mutate_at(vars(manure_beef, manure_dairy, manure_hog, manure_poultry, manure_other,
#                  manure_slurry, manure_dry, manure_lagoon), 
#             list(~ ./manure_total_tons)) %>% 
#   select(year, crop,
#          manure_planted_acres, manure_total_tons,
#          manure_beef, manure_dairy, manure_hog, manure_poultry, manure_other,
#          manure_slurry, manure_dry, manure_lagoon)
# 
# # check planted acres against NASS results - adjust manure amt if needed
# # manure type/state percentages don't always add up to 1 due to data availability in ARMS
# 
# # assume same tillage pct for corn grain and corn silage
# corn_grain <- arms_manure_4 %>% 
#   filter(crop == "Corn") %>% 
#   mutate(crop = "Corn, grain")
# 
# corn_silage <- arms_manure_4 %>% 
#   filter(crop == "Corn") %>% 
#   mutate(crop = "Corn, silage")
# 
# corn <- bind_rows(corn_grain, corn_silage) %>% 
#   ungroup() %>% 
#   mutate(year = as.numeric(year)) %>% 
#   left_join(corn_pct, by = c("year", "crop")) %>% 
#   mutate(manure_planted_acres = manure_planted_acres * pct_corn_acres,
#          manure_total_tons = manure_total_tons * pct_corn_acres) %>% 
#   select(-pct_corn_acres)
# 
# arms_manure_5 <- arms_manure_4 %>% 
#   ungroup() %>% 
#   filter(crop != "Corn") %>% 
#   mutate(year = as.numeric(year)) %>% 
#   bind_rows(corn) %>% 
#   # egc 04/01/2021 selecting only variables of interest
#   select(1:2, 4)
# 
# # save final version
# arms_manure_final <- arms_manure_5
```

## 02 Clean ERS Tillage Intensity - deprecated 05/14/2021

```{r ers_tillage}

# deprecated egc 05/14/2021
# Processing
# ers_tillage_2 <- ers_tillage %>% 
#   # Removing footnotes
#   filter(!is.na(`Tillage practice`)) %>% 
#   # Separating crop year variable
#   separate(col = `Crop/year`, into = c("crop", "year"), sep = ", ") %>% 
#   # Remove unknown tillage
#   filter(!`Tillage practice` == "Not determined") %>% 
#   # Remove standard error variable
#   select(-`Relative standard error (percent)`) %>% 
#   # Recoding tillage categories
#   mutate(`Tillage practice` = case_when(`Tillage practice` == "Conventional" ~ "ers_conventional_till",
#                           `Tillage practice` == "Mulch till" ~ "ers_reduced_till",
#                           `Tillage practice` == "No-till" ~ "ers_no_till",
#                           TRUE ~ `Tillage practice`)) %>% 
#   # Dividing value by 100 to get percent share
#   mutate(`Estimate (percent of planted acres)` = `Estimate (percent of planted acres)`/100) %>% 
#   # Spreading variables to conform with format
#   spread(`Tillage practice`, `Estimate (percent of planted acres)`)
# 
# # Duplicating corn into corn grain, corn silage
# # assume same tillage pct for corn grain and corn silage
# corn_grain <- ers_tillage_2 %>% 
#   filter(crop == "Corn") %>% 
#   mutate(crop = "Corn, grain")
# 
# corn_silage <- ers_tillage_2 %>% 
#   filter(crop == "Corn") %>% 
#   mutate(crop = "Corn, silage")
# 
# corn <- bind_rows(corn_grain, corn_silage) %>% 
#   ungroup() %>% 
#   mutate(year = as.numeric(year))
# 
# ers_tillage_3 <- ers_tillage_2 %>% 
#   ungroup() %>% 
#   filter(crop != "Corn") %>% 
#   mutate(year = as.numeric(year)) %>% 
#   bind_rows(corn) %>% 
#   arrange(year, crop)
# 
# ers_tillage_final <- ers_tillage_3
```

## 02 Cleaning new ERS tillage 2021 data

```{r ers_2021}

ers_tillage_2021_2 <- ers_tillage_2021 %>% 
  select(Crop, `Survey Year`, `Conventional Till, estimate (percent of planted acres)`,
         `Mulch till, estimate (percent of planted acres)`, `No-till, estimate (percent of planted acres)`) %>% 
  rename(crop = Crop,
         year = `Survey Year`,
         conventional_share_2021 = `Conventional Till, estimate (percent of planted acres)`,
         reduced_share_2021 = `Mulch till, estimate (percent of planted acres)`,
         no_till_share_2021 = `No-till, estimate (percent of planted acres)`) %>% 
  mutate(conventional_share_2021 = conventional_share_2021/100,
         reduced_share_2021 = reduced_share_2021/100,
         no_till_share_2021 = no_till_share_2021/100) %>% 
  filter(crop != "Oats") %>% 
  mutate(crop = ifelse(crop == "Corn",
                       "Corn, grain",
                       crop))

ers_2021_corn_silage <- ers_tillage_2021_2 %>% 
  filter(crop == "Corn, grain") %>% 
  mutate(crop = "Corn, silage")

ers_tillage_2021_3 <- ers_tillage_2021_2 %>% 
  bind_rows(ers_2021_corn_silage) %>% 
  arrange(crop, year)

ers_tillage_2021_final <- ers_tillage_2021_3
```

## 02 Aggregating tillage sources

We have three data sources for tillage. This aggregates by crop, year when data points overlap. The latest data from ERS obtained around 05/05/2021 supercedes the previous tillage intensity data ers_tillage_final

```{r avg_till_shares}

# arms_tillage_final %>% nrow()
# ctic_crm_tillage_final %>% nrow()
# ers_tillage_final %>% nrow() - deprecated egc 05/14/2021
# ers_tillage_2021_final %>% nrow()

all_tillage <- ctic_crm_tillage_final %>% 
  # Join all sources
  full_join(arms_tillage_final) %>% 
  #full_join(ers_tillage_final) %>% # deprecated egc 05/14/2021
  full_join(ers_tillage_2021_final) %>% 
  # Gather data to facilitate grouping and summarizing
  gather(key, value, -c(crop, year)) %>% 
  # Add common tillage categories
  mutate(till_type = ifelse(test = key %in% c("ctic_crm_conventional_till", "arms_conventional_till",
                                              "conventional_share_2021"),
                            yes = "conventional_till_share",
                            no = ifelse(test = key %in% c("ctic_crm_reduced_till", "arms_reduced_till",
                                                          "reduced_share_2021"),
                                        yes = "reduced_till_share",
                                        no = "no_till_share"))) %>%
  ungroup() %>% 
  # Keeping out ARMS soybeans 2012 data because it seems off
  filter(!(year == 2012 & crop == "Soybeans" & key %in% c("arms_no_till", "arms_reduced_till"))) %>%
  # Keeping out ARMS rice and peanuts 2013 data because it seems off
  filter(!(year == 2013 & crop %in% c("Rice", "Peanuts") & key %in% c("arms_no_till", "arms_reduced_till"))) %>% 
  group_by(year, crop, till_type) %>% 
  # Calculate average share
  summarize(mean_share = mean(value, na.rm = TRUE)) %>% 
  # Spread again to meet formatting standards
  spread(key = till_type, value = mean_share) %>% 
  ungroup()

# Some NaNs around due to an entire category of tillage type missing for peanuts and rice, not an error
all_tillage[all_tillage == "NaN"] <- 0

# The addition of tillage shares is close to 1 for all crops. Some underestimation will occur
#View(all_tillage %>% mutate(addition_to_what = conventional_till_share + reduced_till_share + no_till_share))

```

## 02 Cleaning ERS Seed data

```{r seed_data}

# Data manually downloaded from https://data.ers.usda.gov/reports.aspx?ID=17883
# Report: Seed Use
ers_seed_data_2 <- ers_seed_data %>% 
  # Filter for seeding rate only
  filter(type == "Average seeding rate") %>% 
  # Gather the data frame
  gather(key = year, value, -c(1:3)) %>% 
  # Make year and value numeric
  mutate(value = as.numeric(value),
         year = as.numeric(year)) %>% 
  # Remove NA values
  filter(!is.na(value)) %>% 
  select(year, crop, type, units, value) %>% 
  mutate(value2 = ifelse(crop %in% c("Corn, grain", "Corn, silage") & year < 2002,
                         value / 1607, # approx 90,0000 seeds divided by 56 lbs https://crops.extension.iastate.edu/cropnews/2017/08/estimating-corn-yields-using-yield-components
                         value)) %>% 
  # There is an error for sorghum. We'll substitute the wrong value for the previous value in the survey
  mutate(value2 = ifelse(test = crop == "Sorghum" & year == 2003,
                         yes = 5.38,
                         no = value2)) %>% 
  # Remove value, type and units
  select(-c(type, units, value)) %>% 
  # Rename value2
  rename(seeding_rate_lbs_per_acre = value2)

# Updated seed use data for four major crops from Laura Dodson, REE-ERS, Washington, DC
# Laura sent updated numbers for a few crops. See file "Seeding Rates for OPM.xlsx"
# These data are not published online as of April 06 2021
latest_ers_seed_use <- read_csv("raw_data/ers_seed_data/latest_seed_use_from_ERS.csv")

# Appending the updated data with what was manually downloaded
ers_seed_data_3 <- ers_seed_data_2 %>% 
  bind_rows(latest_ers_seed_use) %>% 
  arrange(year, crop) %>% 
  # Summarizing when we have more than 1 crop category for the same crop, Barley and Wheat
  mutate(crop2 = case_when(crop == "Barley, feed" ~ "Barley",
                          crop == "Barley, malt" ~ "Barley",
                          crop == "Wheat, durum" ~ "Wheat",
                          crop == "Wheat, spring" ~ "Wheat",
                          crop == "Wheat, winter" ~ "Wheat",
                          TRUE ~ crop)) %>% 
  group_by(year, crop2) %>% 
  summarize(seeding_rate_lbs_per_acre = mean(seeding_rate_lbs_per_acre)) %>% 
  rename(crop = crop2) %>% 
  ungroup()

ers_seed_data_final <- ers_seed_data_3

```

## 02 Cleaning NRI Erosion Data

```{r nri_cleaning}

NRI_soil_erosion_1 <- NRI_soil_erosion %>% 
  mutate(year = as.numeric(year)) %>%
  select(year, crop, erosion_rate) %>% 
  filter(!crop == "Crops") %>% 
  mutate(crop2 = case_when(crop == "Beets" ~ "Sugar beets",
                          TRUE ~ crop)) %>% 
  select(-crop) %>% 
  rename(crop = crop2)

# Duplicating corn into corn grain, corn silage
# assume same tillage pct for corn grain and corn silage
corn_grain <- NRI_soil_erosion_1 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, grain")

corn_silage <- NRI_soil_erosion_1 %>% 
  filter(crop == "Corn") %>% 
  mutate(crop = "Corn, silage")

corn <- bind_rows(corn_grain, corn_silage) %>% 
  ungroup()

NRI_soil_erosion_final <- NRI_soil_erosion_1 %>% 
  ungroup() %>% 
  filter(crop != "Corn") %>% 
  bind_rows(corn) %>%
  select(year, crop, erosion_rate) %>% 
  arrange(year, crop) %>% 
  rename(erosion_rate_tons_acre = erosion_rate)

rm(corn_grain, corn_silage, corn)
```

## 02 Clean rice methane emissions

```{r rice_methane}

# Processing
rice_methane_emissions_2 <- rice_methane_emissions %>% 
  # Converting Million Metric Tons of CO2e to pounds, all mass conversions
  mutate(CO2e_total_lbs = MMT_CO2e * 1000000 * 2204.62,
         # Thousand hectares to acres
         harvested_acreage = (harvested_ha_thousands * 1000) / 0.404686,
         # Calculating methane emissions per harvested acre. Side note, the harvested acreage doesn't match NASS data
         # Stephen Ogle said they use National Resources Inventory data rather than NASS data, personal comm
         methane_CO2e_acre = round(CO2e_total_lbs / harvested_acreage, 1)
         ) %>% 
  select(year, crop, methane_CO2e_acre)

rice_methane_final <- rice_methane_emissions_2
```

## 02 Clean eGRID efficiency data

```{r eGRID}

# Removing data source
egrid_efficiency_2 <- egrid_efficiency %>% 
  select(-source)

# Quadratic model provides a better fit to fill data back to 1980
quad_mld <- lm(lb_CO2_MWh ~ year + I(year^2), data = egrid_efficiency)

# Creating dataset to add predictions
explanatory_data <- data.frame(
  year = 1980:2020
)

predicted_efficiency <- explanatory_data %>% 
  mutate(lb_CO2_MWh = predict(quad_mld, explanatory_data))

# highest curve number to use as replacement because the quad function dips
max(predicted_efficiency$lb_CO2_MWh)

# pulling index value lb_CO2_MWh for a specific year for ratio calculation
efficiency_index_value <- predicted_efficiency %>% 
  filter(year == 2014) %>% # what year should we choose? 2009 for pesticides? 2014 for fertilizers? for irrigation the latest year? Pulling 2014 because metric updates were done with GREET 2014 model
  pull(lb_CO2_MWh) %>% 
  unname()

eGRID_efficiency_final <- predicted_efficiency %>% 
  # Replacing data before 1992
  mutate(lb_CO2_MWh = ifelse(year < 1992, # the year the curve drops going back to 1980
                             max(predicted_efficiency$lb_CO2_MWh),
                             lb_CO2_MWh)) %>% 
  # Calculating efficiency ratio, this will be used to multiply the emissions for irrigation, pesticides, fertilizers, maybe potato storage
  mutate(egrid_efficiency_ratio = lb_CO2_MWh / efficiency_index_value) %>% 
  select(-lb_CO2_MWh)

```

## Cleaning application data (number of passes)

```{r num_passes}

nass_num_passes_2 <- nass_num_passes %>%
  select(year, commodity_desc, domain_desc, domaincat_desc, Value) %>% 
  mutate(Value = as.numeric(Value)) %>% 
  filter(!is.na(Value)) %>% 
  filter(domain_desc %in% c("CHEMICAL, FUNGICIDE", "CHEMICAL, HERBICIDE", "CHEMICAL, INSECTICIDE",
                            "CHEMICAL, OTHER", "FERTILIZER")) %>% 
  filter(domaincat_desc != "FERTILIZER: (SULFUR)") %>% 
  group_by(year, commodity_desc, domain_desc) %>% 
  top_n(5, Value) %>% # for each category, we keep the top 5 values due to large number of 1-application chemicals
  ungroup() %>% 
  mutate(commodity_desc = str_to_sentence(commodity_desc),
         commodity_desc = case_when(commodity_desc == "Potatoes, fall" ~ "Potatoes",
                          commodity_desc == "Wheat, spring, (excl durum)" ~ "Wheat",
                          commodity_desc == "Wheat, spring, durum" ~ "Wheat",
                          commodity_desc == "Wheat, winter" ~ "Wheat",
                          commodity_desc == "Sugarbeets" ~ "Sugar beets",
                          TRUE ~ commodity_desc),
         # Creating the proper categories for aggregating, not that easy
         domaincat_desc = ifelse(str_detect(domaincat_desc, "CHEMICAL"),
                                      domain_desc,
                                      domaincat_desc),
         domaincat_desc = ifelse(str_detect(domaincat_desc, "PHOSPHATE|POTASH"), # combine P and K
                                 "P + K",
                                 domaincat_desc))

nass_num_passes_3 <- nass_num_passes_2 %>% 
  group_by(year, commodity_desc, domaincat_desc) %>% 
  summarize(avg_applications = mean(Value),
            n = n()) %>% 
  group_by(year, commodity_desc) %>% 
  summarize(total_application_passes = sum(avg_applications)) %>% 
  ungroup()

passes_corn_grain <- nass_num_passes_3 %>% 
  filter(commodity_desc == "Corn") %>% 
  mutate(commodity_desc = "Corn, grain")

passes_corn_silage <- nass_num_passes_3 %>% 
  filter(commodity_desc == "Corn") %>% 
  mutate(commodity_desc = "Corn, silage")

corn_bind <- passes_corn_grain %>% 
  bind_rows(passes_corn_silage)

nass_num_passes_4 <- nass_num_passes_3 %>% 
  filter(commodity_desc != "Corn") %>% 
  bind_rows(corn_bind) %>% 
  arrange(year, commodity_desc) %>% 
  rename(crop = commodity_desc) %>% 
  mutate(total_application_passes = round(total_application_passes/1.5, 1),
         year = as.numeric(year))

nass_num_passes_final <- nass_num_passes_4

# The method is as follows: The top 5 applications are kept. This is only for the chemical categories, which has a large number of 1-application active ingredients that are diluting the averages. Chemical categories contribute an average each, P + K contributes an average of P an K, Nitrogen contributes all of its contents, then all applications are summed up. Initially, I am assuming that no crop protectant applications are combined, that P and K applications are combined, and that N applications are not combined either. Then I divide the final number by 1.5 to account for a measure of applications that are typically combined.

```

## Cleaning nitrogen production efficiency

```{r n_efficiency}
# pulling index value for the last year
N_production_efficiency_index_value <- N_production_efficiency %>% 
  filter(year == 2020) %>%
  pull(value) %>% 
  unname()

IFA_NH3_efficiency_final <- N_production_efficiency %>% 
  # Calculating efficiency ratio, this will be used to multiply the energy for nitrogen
  mutate(IFA_efficiency_multiplier = value / N_production_efficiency_index_value) %>% 
  select(-value)
```

## Cleaning global CO2 intensity

```{r globalCO2intensity}

global_CO2_index <- global_CO2_intensity %>% 
  tail(n = 1) %>% 
  pull(value)

global_CO2_intensity_final <- global_CO2_intensity %>% 
  mutate(CO2_intensity_multiplier = value / global_CO2_index) %>% 
  select(-value)

```

## Cleaning global energy intensity

```{r global_energy}
global_energy_intensity_final <- global_energy_intensity
```

## Cleaning irrigation power source share
```{r irri_power}

# Creating blank data frame to receive the data
irrigation_power_trend <- data.frame(
  year = 1979:2019
  ) %>% 
  left_join(fris_irrigation_power_source)

# Imputing the 2018 data to 2020 to fill in
data_2020 <- irrigation_power_trend %>% 
  filter(year == 2018) %>% 
  mutate(year = 2020)

irrigation_power_trend_final <- irrigation_power_trend %>% 
  bind_rows(data_2020) %>% 
  mutate_all(zoo::na.approx, na.rm = F) %>% 
  filter(year != 1979)
```
## 02 Save Output 02

```{r saving_output_02}
# Join & Save

indicators_input <- nass_land_use_final %>% 
  left_join(fris_irrigation_final) %>% 
  #left_join(ctic_crm_tillage_final) %>% # replaced with all_tillage
  # left_join(ctic_optis_tillage_final) %>% # egc note 03/17 - Kathy excluded CTIC Optis data
  left_join(arms_manure_final) %>% 
  #left_join(arms_tillage_final) %>% # replaced with all_tillage
  left_join(nass_chemicals_final) %>% 
  #left_join(ers_tillage_final)# replaced with all_tillage
  left_join(all_tillage) %>% 
  left_join(ers_seed_data_final) %>% 
  left_join(NRI_soil_erosion_final) %>%
  left_join(area_burned) %>%
  left_join(rice_methane_final) %>% 
  left_join(eGRID_efficiency_final) %>% 
  left_join(removal_residue) %>% 
  left_join(nass_num_passes_final) %>%
  left_join(IFA_NH3_efficiency_final) %>% 
  left_join(global_CO2_intensity_final) %>% 
  left_join(global_energy_intensity_final) %>%
  left_join(irrigation_power_trend_final) %>% 
  filter(!year == 2021) %>% # removing 2021 data which is starting to show up with the USDA API Queries
  # Here I should do the sugar beets sucrose adjustment
  # I am joining the sugar beets sucrose pct here, doing the yield adjustment for sucrose, and removing the variable
  # Pct sucrose is not given at national level by NASS, so I averaged all available data by year
  # This way, sugar beets is expressed in tons sugar/acre, rather than raw tons
  left_join(sugarbeets_sucrose_pct_2) %>%
  fill(sucrose_pct, .direction = "down") %>% # data imputation for 2019-2020
  mutate(yield = ifelse(crop == "Sugar beets",
                        yield * (sucrose_pct/100),
                        yield),
         production = ifelse(crop == "Sugar beets",
                        production * (sucrose_pct/100),
                        production),
         yield_irrigated = ifelse(crop == "Sugar beets",
                        yield_irrigated * (sucrose_pct/100),
                        yield_irrigated),
         yield_non_irrigated = ifelse(crop == "Sugar beets",
                        yield_non_irrigated * (sucrose_pct/100),
                        yield_non_irrigated)) %>% 
  mutate(yield = round(yield, 1),
         production = round(production, 1),
         yield_irrigated = round(yield_irrigated, 1),
         yield_non_irrigated = round(yield_non_irrigated, 1),) %>% 
  select(-sucrose_pct)

save(indicators_input, file = "r_data/outputs_02_egc.rda")

# a quality check View(indicators_input %>% count(crop))
```

# 03 Fill-in Missing Data

## 03 Load Data If Needed
```{r load_outputs_02_egc}
# Load data from previous step

load("r_data/outputs_02_egc.rda")

input <- indicators_input
```

## 03 Calculate New Yield Variables

```{r new_yield}
# Average yield
# re-calculate yield per acre planted and yield per acre harvested
input_2 <- input %>% 
  mutate(yield_planted = production/acres_planted,
         yield_harvested = production/acres_harvested)
```

## 03 Seeding rates for potatoes, sugar beets and other fixes

```{r seed_rates_fixes}

# Research from report titled Acres Planted per Day and Seeding Rates of Crops Grown in the United States, EPA 2010
# Potatoes in page 36
# Sugar beets in page 41. I won't use the undated sources. Let's use the rate of 55,000 seeds/acre or 5.5 lb/acre when divided by 10,000 seeds per acre, from the Colorado USDA reference in 2003
# 10,000 seeds/lb for sugar beets https://antlerking.com/product/antler-king-brand-sugar-beets-1-lb/
# this resource mentions 1-2 lb/acre seeding rate for sugar beets https://hort.purdue.edu/newcrop/afcm/sugarbeet.html
input_2 <- input_2 %>%
  mutate(seeding_rate_lbs_per_acre = case_when(
    crop == "Potatoes" ~ 2400, # Middle range of EPA report. 2,100 to 2,700 lb/acre.
    crop == "Sugar beets" ~ 5.5, # units here are lb/acre
    TRUE ~ seeding_rate_lbs_per_acre
  ))

# Potato chemicals and fertilizers have a serious data anomaly for years 1996, 1996 and 1996, respectively
# Potato production experts were consulted and it was decided that these USDA NASS values are erroneous
# What we are doing below is to delete the erroneous values, and let the interpolation fill these values at the end of Step 3 processing using the data from the year before and after the anomalies
input_2 <- input_2 %>%
  mutate(chemical_fumigant = ifelse(crop == "Potatoes" & year %in% c(1996, 1998),
                                         NA,
                                         chemical_fumigant),
         chemical_fungicide = ifelse(crop == "Potatoes" & year %in% c(1996, 1998),
                                    NA,
                                    chemical_fungicide),
         chemical_herbicide = ifelse(crop == "Potatoes" & year %in% c(1996, 1998),
                                     NA,
                                     chemical_herbicide),
         chemical_insecticide = ifelse(crop == "Potatoes" & year %in% c(1996, 1998),
                                     NA,
                                     chemical_insecticide),
         fertilizer_nitrogen = ifelse(crop == "Potatoes" & year %in% c(1996),
                                     NA,
                                     fertilizer_nitrogen),
         fertilizer_phosphate = ifelse(crop == "Potatoes" & year %in% c(1996),
                                     NA,
                                     fertilizer_phosphate),
         fertilizer_potash = ifelse(crop == "Potatoes" & year %in% c(1996),
                                     NA,
                                     fertilizer_potash))
```

## 03 FRIS

```{r fris_processing}
# Irrigated vs non-irrigated acres and yields
# egc note 08/10/2021. Kathy used yield_harvested and acres_harvested rather than yield_planted and acres_planted to be consistent with FRIS/IWMS data, which reports acres harvested. We talked about it with Allison on 08/10/2021

# get years where FRIS is available
fris <- input_2 %>% 
  filter(!is.na(yield_irrigated)) %>% 
  select(year, crop, yield_harvested, acres_harvested,
         yield_irrigated, yield_non_irrigated, acres_irrigated, acres_non_irrigated) %>% 
  mutate(acres_harvested_fris = acres_irrigated + acres_non_irrigated) # check total harvested acres from FRIS against total harvested acres from NASS Quick Stats - numbers differ by order of magnitude, because FRIS includes only farms that use irrigation?

# calculate ratios
fris_2 <- fris %>%
  mutate(ratio_yield_irrigated = yield_irrigated / yield_harvested,
         ratio_yield_non_irrigated = yield_non_irrigated / yield_harvested,
         ratio_acres_irrigated = acres_irrigated / acres_harvested) %>% 
  group_by(crop) %>% 
  arrange(year) %>% 
  # calculate 4-year average ratios
  mutate(ratio_yield_irrigated_lag = lag(ratio_yield_irrigated),
         ratio_yield_non_irrigated_lag = lag(ratio_yield_non_irrigated),
         ratio_acres_irrigated_lag = lag(ratio_acres_irrigated),
         avg_ratio_yield_irrigated = (ratio_yield_irrigated + ratio_yield_irrigated_lag)/2,
         avg_ratio_yield_non_irrigated = (ratio_yield_non_irrigated + ratio_yield_non_irrigated_lag)/2,
         avg_ratio_acres_irrigated = (ratio_acres_irrigated + ratio_acres_irrigated_lag)/2) %>% 
  # use average ratio for all intermediate years in the 5-year period, starting with 1984
  complete(year = 1984:2018, crop) %>% 
  fill(avg_ratio_yield_irrigated, avg_ratio_yield_non_irrigated, avg_ratio_acres_irrigated, .direction = "up") %>% 
  # for 2014-2018, use the most recent 5-year average ratio (2008-2013)
  fill(avg_ratio_yield_irrigated, avg_ratio_yield_non_irrigated, avg_ratio_acres_irrigated, .direction = "down") %>% 
  select(year, crop, starts_with("avg_ratio"))

# Update 2021-09-30
# The processing in this chunk only helps sugar beets
# Allison and I decided to use simple linear interpolation for the rest of the crops, the trends look cleaner

fris_2_sugarbeets_only <- fris_2 %>% 
  filter(crop == "Sugar beets")

# Using the ratios from the previous step to fill up where needed
input_3 <- input_2 %>% 
  left_join(fris_2_sugarbeets_only, by = c("year", "crop")) %>% 
  # estimate irrigated vs non-irrigated acres/yields using average ratios
  mutate(yield_irrigated = ifelse(is.na(yield_irrigated), 
                                  yield_harvested * avg_ratio_yield_irrigated, 
                                  yield_irrigated),
         yield_non_irrigated = ifelse(is.na(yield_non_irrigated), 
                                      yield_harvested * avg_ratio_yield_non_irrigated, 
                                      yield_non_irrigated),
         acres_irrigated = ifelse(is.na(acres_irrigated), 
                                  acres_harvested * avg_ratio_acres_irrigated, 
                                  acres_irrigated)) #%>% 
  # for 1980-1984, use 1984 values (these are not estimated using ratios)
  #group_by(crop) %>% 
  #arrange(year) %>% 
  #fill(yield_irrigated, yield_non_irrigated, acres_irrigated, .direction = "up")
```

## 03 Fill-In Tillage

```{r fill_tillage}
# 04/09/2021 This is no longer correct, I have created composite tillage share variables
# Tillage
# for now, use CTIC CRM data - no, this is primitive
# input_4 <- input_3 %>% 
#   mutate(tillage_no_till = ctic_crm_conservation_no_till,
#          tillage_reduced_till = sum(ctic_crm_reduced_till, ctic_crm_conservation_mulch_till, ctic_crm_conservation_ridge_till, na.rm = TRUE),
#          tillage_conventional_till = ctic_crm_conventional_till) %>% 
#   # delete unused variables
#   select(-starts_with("ctic_crm"), starts_with("arms_"))
```

## 03 Fill-In Manure

```{r fill_manure}
# Manure
# egc 03/17/2021 - already added
```

## 03 Fill-in Everything Else

```{r fill_everything}
# Everything else:
# - Linearly interpolate between data points
# - Fill in missing values at either end with the closest available value
input_4 <- input_3 %>% 
  # calculate percent irrigated using wells
  mutate(pct_wells = acre_wells/acres_irrigated) %>% 
  mutate(across(starts_with("chemical_"),
                .fns = list(rate_per_acre = ~ ./acres_planted),
                .names = "{fn}_{col}")) %>% 
  mutate(across(starts_with("fertilizer_"),
                .fns = list(rate_per_acre = ~ ./acres_planted),
                .names = "{fn}_{col}")) %>% 
  mutate(across(where(is.numeric), ~na_if(., 0))) %>% 
  # delete unnecessary variables
  select(-acres_non_irrigated)

# More important processing and variable selection. Revise script with addition of new columns
input_5 <- input_4 %>% 
  group_by(crop) %>% 
  arrange(year) %>% 
  # linearly interpolate between data points using zoo::na.approx
  mutate_all(na.approx, na.rm = FALSE) %>%
  # fill in values at two ends with the closest available value
  fill(everything(), .direction = "up") %>% # can we use .fns like above to get new variables with filled data?
  fill(everything(), .direction = "down") %>% # same as above
  mutate(across(starts_with("rate_per_acre"),
                .fns = list(totals_ = ~ .*acres_planted),
                .names = "{fn}_{col}")) %>%
  # remove unnecessary variables
  select(-c(chemical_fumigant:fertilizer_potash, rate_per_acre_chemical_fumigant:rate_per_acre_fertilizer_potash))
  #select(1:17, 26:45, 49, 58:65) # watch out for this! I already tripped multiple times here - egc - 04/19/2021

#View(names(input_5))

names(input_5) <- str_remove_all(string = names(input_5), pattern = "totals__rate_per_acre_")

# Note about manure. I don't think it's appropriate to give manure data the same processing as for chemical protection products and fertilizers. The ARMS manure data doesn't show that manure applications have a clear trend to adjust according to the crop acreage for a given year. The manure data gets interpolated between years, and filled up and down with the first and last values for an entire crop series.
```

## 03 Save Output 03

```{r saving_output_03}
# Save
indicators_input_filled <- input_5

save(indicators_input_filled, file = "r_data/outputs_03_egc.rda")
```

# Step 04 - Calculating Metrics

Here we are!

## 04 Load data

```{r load_output_03}

load("r_data/outputs_03_egc.rda")

```

## 04 Metrics Calculations

```{r calculating_metrics}

# Crop vector for reference
crops <- unique(indicators_input_filled$crop)

# Importing factors (this probably will need many updates - egc 04/12/2021)
factors <- read_excel("raw_data/conversion_factors.xlsx", sheet = "data") %>% 
  rename_all(~ (paste0("c_",.))) %>% 
  rename(crop = c_crop)

# Constants, other factors
gal_diesel_to_BTU <- 138490
gal_diesel_to_CO2 <- 22.4 # https://www.eia.gov/environment/emissions/co2_vol_mass.php
nitrogen_btu_lb <-  27119 # updated 07/06/2021
nitrogen_co2_lb <- 3.04 # updated 07/06/2021
phosphorus_btu_lb <-  13212 # updated 07/06/2021
phosphorus_co2_lb <- 1.88 # updated 07/06/2021
potassium_btu_lb <-   3484 # updated 07/06/2021
potassium_co2_lb <- 0.52 # updated 07/06/2021
application_pass_btu <- round(138490 * 0.1285)
n2o_emissions_factor <- 1/100 # old factor, only being used for residue removal credit

# Below are direct conversions from Audsley 2009
# MJ/kg ai are converted to BTU/lb ai by multiplying by (947.8/2.20462)
# 1 MJ to BTU	947.8
# 1 kg to lb	2.20462

c_herbicide_btu_lb <- 165947
c_insecticide_btu_lb <- 117797
c_fungicide_btu_lb <- 181854
c_growth_reg_btu_lb <- 118657
c_fumigant_btu_lb <- 165947 # same as herbicide

# lb CO2e/lb ai are obtained as Audsley 2009 suggested
# A factor of 0.069 kg CO2 equivalent per MJ pesticide energy can be used to convert these to the Global Warming Potential (100 years). Since the units are kg CO2e/kg ai, it's the same as lb CO2e/lb ai

c_herbicide_co2e_lb <- 26.63
c_insecticide_co2e_lb <- 18.91
c_fungicide_co2e_lb <- 29.19
c_growth_reg_co2e_lb <- 19.04
c_fumigant_co2e_lb <- 26.63 # same as herbicide

input <- indicators_input_filled %>% 
  filter(!crop == "Cotton")

# Very important step, all NAs converted to 0 to be able to complete row sums
# Let's keep an eye open for unintended consequences
input[is.na(input)] <- 0

input_2 <- input %>% 
  # Creating water applied in acre inches instead of acre feet
  mutate(water_applied_acre_inches = water_applied * 12) %>%
  # Creating delta for irrigated - non-irrigated yield
  mutate(yield_irrigation_delta = yield_irrigated - yield_non_irrigated,
         production_irrigation_delta = acres_irrigated * yield_irrigation_delta) %>% 
  # Merging with multipliers and other important factors
  left_join(factors, by = "crop")

# Calculating the rest of the metrics
input_3 <- input_2 %>% 
  mutate(
    
    #### land use ####
    
    # unit: acre planted per unit of crop
    land_use_fp = 1 / yield_planted,
    
    #### irrigation water use ####
    # unit: inches of water per unit increase in yield (due to irrigation)
    irrigation_water_use_fp = water_applied_acre_inches / yield_irrigation_delta,
    
    #### tillage, management energy ####
    
    # unit: lbs of CO2e per acre
    # conversion: kg to pound (2.204), hectare to acre (1/2.471), and C to CO2 (44/12)
    emissions_conventional_till = conventional_till_share * c_emissions_conventional_till * 
      (2.204 / 2.471) * (44 / 12),
    emissions_reduced_till = reduced_till_share * c_emissions_reduced_till * 
      (2.204 / 2.471) * (44 / 12),
    emissions_no_till = no_till_share * c_emissions_no_till * 
      (2.204 / 2.471) * (44 / 12),
    
    # unit: lbs of CO2e per acre
    emissions_tillage = emissions_conventional_till + emissions_reduced_till + emissions_no_till,
    
    #manure_per_acre = manure_total / acres_planted, # already calculated as manure_rate_all_acreage
    
    # unit: gallons of diesel per acre
    # conversion: unknown source (0.0287 = standard factor, 3 = 3 times as much energy as a non-manure pass)
    energy_use_manure_gal_diesel = manure_rate_all_acreage * 0.0287 * 3,
    
    # unit: gallons of diesel per acre
    energy_use_tillage_gal_diesel = emissions_tillage / gal_diesel_to_CO2,
    
    # unit: gallons of diesel per acre
    energy_use_machinery_gal_diesel = energy_use_tillage_gal_diesel + energy_use_manure_gal_diesel,
    
    # unit: BTUs per acre
    management_BTUs_per_acre = energy_use_machinery_gal_diesel * gal_diesel_to_BTU,
    
    # unit: CO2e per acre
    management_CO2e_per_acre = energy_use_machinery_gal_diesel * gal_diesel_to_CO2,
    
    # unit: total BTUs
    management_total_BTUs = management_BTUs_per_acre * acres_planted,
    
    # unit: total CO2e
    management_total_CO2e = management_CO2e_per_acre * acres_planted,
    
    #### Irrigation calculations - egc ####
    
    # unit: psi
    avg_pressure = pct_wells * pressure_wells_all_crops + (1 - pct_wells) * pressure_wells_all_crops,
    
    # unit: feet
    avg_lift = pct_wells * depth_wells_all_crops + (1 - pct_wells) * lift_non_wells_all_crops,
   
    # conversion: feet to inch (12), inch to mm (1/25.4), other factors unknown (standard engineering equation?)
    # PSI to meters head/psi (ME) = .703448
    # feet to meters (FM) = 0.3048 
    # I suspect the number 804.2 is a BTU to MJ conversion, maybe. Not sure.
    # unit: gallons of diesel per acre
    #energy_use_irrigation_gal_diesel_per_acre = (avg_pressure * 0.703448 + avg_lift * 0.3048) *
    #  (water_applied_acre_inches * 25.4) / 804.2,
    
    # units: total gallons of diesel
    #energy_use_irrigation_total_gal_diesel = energy_use_irrigation_gal_diesel_per_acre * acres_irrigated,
    
    # units: total emissions in CO2e
    #irrigation_total_CO2e = energy_use_irrigation_total_gal_diesel * gal_diesel_to_CO2,
    
    #irrigation_CO2e_per_acre = irrigation_total_CO2e / acres_irrigated,
    
    # Here we can adjust the emissions with the electricity grid factor
    #irrigation_total_CO2e_grid_adjusted = irrigation_total_CO2e * egrid_efficiency_ratio,
    
    #irrigation_CO2e_grid_adjusted_per_acre = irrigation_total_CO2e_grid_adjusted / acres_irrigated,
    
    # units: total BTUs
    #irrigation_total_BTUs = energy_use_irrigation_total_gal_diesel * gal_diesel_to_BTU,
    
    #irrigation_BTUs_per_acre = irrigation_total_BTUs / acres_irrigated,
    
    # total acre inches, I don't think we use this
    #irrigation_total_water = water_applied_acre_inches * acres_irrigated,
    
    # Irrigation method updated, using the same method as with the current metrics for irrigation energy and GHGs
    # Calculations based on equations 19.1, 19.2 and table 19.1 on pages 723&724 of: Hoffman, G.J., T.A. Howell, and
    #K.H. Solomon. 1992. Management of Farm Irrigation Systems, ASAE Monograph Number 9
    # BTUs and CO2 per fuel are from https://www.eia.gov/environment/emissions/co2_vol_mass.php and
    # https://afdc.energy.gov/files/u/publication/fuel_comparison_chart.pdf
    # See Irrigation Energy Use Metrics documentation for formula details
    # I also changed acres_irrigated to acres_planted, a departure from 2016 NIR for the per_acre variables
    irrigation_head = ((avg_pressure / 0.145) * 0.102) + (avg_lift * 0.3048),
    
    # Total BTUs
    irrigation_total_BTUs = (((irrigation_head * 0.0979) * (water_applied_acre_inches * 25.4) *
                              (acres_irrigated * 0.404686)) / (0.75 * 1 * 0.95 * 1)) * 948,
    irrigation_BTUs_per_acre = irrigation_total_BTUs / acres_planted,

    # Total CO2e adjusted by eGRID efficiency, power source and their corresponding coefficients
    irrigation_total_CO2e_grid_adjusted = (((((irrigation_total_BTUs * irrigation_electricity_acres_fraction) /
                                                3412) * 1.12) * egrid_efficiency_ratio) + # electricity
      (((irrigation_total_BTUs * irrigation_diesel_acres_fraction) / gal_diesel_to_BTU) * gal_diesel_to_CO2) + # diesel
      (((irrigation_total_BTUs * irrigation_gasoline_acres_fraction) / 124340) * 19.6) + # gasoline
      (((irrigation_total_BTUs * irrigation_naturalgas_acres_fraction) / 1026) * 0.117) + # natural gas
      (((irrigation_total_BTUs * irrigation_propane_acres_fraction) / 91420) * 12.7)), # propane
    
    irrigation_CO2e_grid_adjusted_per_acre = irrigation_total_CO2e_grid_adjusted / acres_planted,# change here
    
    # Unadjusted values for completion
    irrigation_total_CO2e = (((((irrigation_total_BTUs * irrigation_electricity_acres_fraction) /
                                                3412) * 1.12)) + # electricity
      (((irrigation_total_BTUs * irrigation_diesel_acres_fraction) / gal_diesel_to_BTU)*gal_diesel_to_CO2) + # diesel
      (((irrigation_total_BTUs * irrigation_gasoline_acres_fraction) / 124340) * 19.6) + # gasoline
      (((irrigation_total_BTUs * irrigation_naturalgas_acres_fraction) / 1026) * 0.117) + # natural gas
      (((irrigation_total_BTUs * irrigation_propane_acres_fraction) / 91420) * 12.7)), # propane
    
    irrigation_CO2e_per_acre = irrigation_total_CO2e / acres_planted,
    
    #### drying ####
    # unit: total BTUs
    # Identify crop, drying system used and points of moisture removed
    # Use Table 11 to look up pounds of water removed per unit yield (e.g. 1.33 lbs water per bu)
    # Calculate water removed (lbs) by multiplying Table 11 value by production (Yield * Area)
    # Calculate total energy: multiply total water removed by drying season thermal efficiency (BTU/lb water) from         Table 10
    # PHE = total BTU/field area
    # For common crops, we are assuming drying method In bin - combination high temperature and air with 75/25 fuel/electric

    drying_total_BTUs = case_when(
      crop %in% c("Barley", "Corn, grain", "Rice", "Sorghum", "Soybeans", "Wheat") ~ 
        c_lb_water_removed * production * 1200,
      # 300 BTUs for normal moisture, 293 extra BTUs requested by Cotton, 83% lint factor will be applied at the end
      crop == "Cotton" ~ production * (300 + 293), # * 0.83
      crop == "Peanuts" ~ (production * (((62618 * c_pts_moisture_removed) - 578344) / 2000)) + 
        (production * ((((2.991 * c_pts_moisture_removed) - 27.7) / 2000) * 3412.14)), # peanut has two parts
      crop == "Potatoes" ~ 3050 * production, # 3050 BTUs/cwt for ventilation in storage, see 2016 report
      crop %in% c("Corn, silage", "Sugar beets") ~ 0#,
      #TRUE ~ value
      ),
    
    drying_BTUs_per_acre = drying_total_BTUs / acres_planted,
    
    drying_total_CO2e = case_when(
      crop %in% c("Barley", "Corn, grain", "Rice", "Sorghum", "Soybeans", "Wheat") ~ 
        (((drying_total_BTUs/gal_diesel_to_BTU) * 0.75)*gal_diesel_to_CO2) +  # fuel portion
        (((drying_total_BTUs/3412) * 0.25)*1.12), # electric portion, 1.12 lb CO2e / kWh national average egrid 2014
      crop == "Cotton" ~ drying_total_BTUs/gal_diesel_to_BTU * gal_diesel_to_CO2, # regular conversion
      # 86% of BTUs from peanuts are from propane, the remainder 14% are from electricity
      crop == "Peanuts" ~ (((drying_total_BTUs * 0.86) / 91420) * 12.7) +
        (((drying_total_BTUs * 0.14) / 3412) * 1.12), # propane and electricity conversion
      crop == "Potatoes" ~ drying_total_BTUs/gal_diesel_to_BTU * gal_diesel_to_CO2, # regular conversion
      crop %in% c("Corn, silage", "Sugar beets") ~ 0#,
      #TRUE ~ value
      ),
    
    drying_CO2e_per_acre = drying_total_CO2e / acres_planted,
    
    # Drying adjusted for CO2 emissions from electrical production portion only
    #drying_total_CO2e_eGRID_adjusted = drying_total_CO2e * egrid_efficiency_ratio,# this is wrong, only adjust electrical portion
    
    drying_total_CO2e_eGRID_adjusted = case_when(
      crop %in% c("Barley", "Corn, grain", "Rice", "Sorghum", "Soybeans", "Wheat") ~ 
        (((drying_total_BTUs / gal_diesel_to_BTU) * 0.75) * gal_diesel_to_CO2) +  # fuel portion
        ((((drying_total_BTUs / 3412) * 0.25) * 1.12) * egrid_efficiency_ratio), # electric portion, 1.12 lb CO2e / kWh national average egrid 2014 and the eGRID adjustment
      crop == "Cotton" ~ (drying_total_BTUs / gal_diesel_to_BTU) * gal_diesel_to_CO2 * egrid_efficiency_ratio, # regular conversion
      # 86% of BTUs from peanuts are from propane, the remainder 14% are from electricity
      crop == "Peanuts" ~ (((drying_total_BTUs * 0.86) / 91420) * 12.7) +
        ((((drying_total_BTUs * 0.14) / 3412) * 1.12) * egrid_efficiency_ratio), # propane and electricity conversion
      crop == "Potatoes" ~ drying_total_BTUs/gal_diesel_to_BTU * gal_diesel_to_CO2 * egrid_efficiency_ratio, # regular conversion
      crop %in% c("Corn, silage", "Sugar beets") ~ 0#,
      #TRUE ~ value
      ),
    
    drying_CO2e_per_acre_eGRID_adjusted = drying_total_CO2e_eGRID_adjusted / acres_planted,
    
    #### chemicals ####
    
    # unit: total BTUs, massive number, we'll divide by a million or billion at the very end
    herbicide_total_BTUs = chemical_herbicide * c_herbicide_btu_lb,
    insecticide_total_BTUs = chemical_insecticide * c_insecticide_btu_lb,
    fungicide_total_BTUs = chemical_fungicide * c_fungicide_btu_lb,
    growth_reg_total_BTUs = chemical_growth_reg * c_growth_reg_btu_lb,
    fumigant_total_BTUs = chemical_fumigant * c_fumigant_btu_lb,

    chemicals_total_BTUs = (herbicide_total_BTUs + insecticide_total_BTUs + fungicide_total_BTUs +
                              growth_reg_total_BTUs + fumigant_total_BTUs),
    
    chemicals_BTUs_per_acre = chemicals_total_BTUs / acres_planted,
    
    chemicals_total_BTUs_global_adjustment = chemicals_total_BTUs * global_energy_efficiency_multiplier,
    
    chemicals_BTUs_per_acre_global_adjustment = chemicals_total_BTUs_global_adjustment / acres_planted,
    
    # unit: total CO2e, massive number, we'll divide by a million or billion at the very end
    herbicide_total_CO2e = chemical_herbicide * c_herbicide_co2e_lb,
    insecticide_total_CO2e = chemical_insecticide * c_insecticide_co2e_lb,
    fungicide_total_CO2e = chemical_fungicide * c_fungicide_co2e_lb,
    growth_reg_total_CO2e = chemical_growth_reg * c_growth_reg_co2e_lb,
    fumigant_total_CO2e = chemical_fumigant * c_fumigant_co2e_lb,

    chemicals_total_CO2e = (herbicide_total_CO2e + insecticide_total_CO2e + fungicide_total_CO2e +
                              growth_reg_total_CO2e + fumigant_total_CO2e),
    
    chemicals_CO2e_per_acre = chemicals_total_CO2e / acres_planted,
    
    chemicals_total_CO2e_global_adjustment = chemicals_total_CO2e * CO2_intensity_multiplier,
    
    chemicals_CO2e_per_acre_global_adjustment = chemicals_total_CO2e_global_adjustment / acres_planted,
    
    #### fertilizers ####
    
    # unit: total BTUs, massive number, we'll divide by a million or billion at the very end
    nitrogen_total_BTUs = fertilizer_nitrogen * nitrogen_btu_lb,
    phosphorus_total_BTUs = fertilizer_phosphate * phosphorus_btu_lb,
    potassium_total_BTUs = fertilizer_potash * potassium_btu_lb,

    fertilizer_total_BTUs = (nitrogen_total_BTUs + phosphorus_total_BTUs + potassium_total_BTUs),
    
    fertilizer_BTUs_per_acre = fertilizer_total_BTUs / acres_planted,
    
    fertilizer_total_BTUs_adjusted = ((nitrogen_total_BTUs * IFA_efficiency_multiplier) + 
                                        (phosphorus_total_BTUs * global_energy_efficiency_multiplier) +
                                        (potassium_total_BTUs * global_energy_efficiency_multiplier)),
    
    fertilizer_BTUs_per_acre_adjusted = fertilizer_total_BTUs_adjusted / acres_planted,
    
    # unit: total CO2e, massive number, we'll divide by a million or billion at the very end
    nitrogen_total_CO2e = fertilizer_nitrogen * nitrogen_co2_lb,
    phosphorus_total_CO2e = fertilizer_phosphate * phosphorus_co2_lb,
    potassium_total_CO2e = fertilizer_potash * potassium_co2_lb,

    fertilizer_total_CO2e = (nitrogen_total_CO2e + phosphorus_total_CO2e + potassium_total_CO2e),
    
    fertilizer_CO2e_per_acre = fertilizer_total_CO2e / acres_planted,
    
    fertilizer_total_CO2e_adjusted = ((nitrogen_total_CO2e * IFA_efficiency_multiplier) + 
                                        (phosphorus_total_CO2e * CO2_intensity_multiplier) + 
                                        (potassium_total_CO2e * CO2_intensity_multiplier)),
    
    fertilizer_CO2e_per_acre_adjusted = fertilizer_total_CO2e_adjusted / acres_planted,
    
    #### seed ####
    # unit: million BTUs
    #energy_use_seed = (energy_use_machinery + energy_use_irrigation + energy_use_drying + energy_use_chemicals +
    #                     energy_use_fertilizers) * c_seed_input_intensity_factor * c_seed_yield_factor,
    # I updated with current metrics methods
    
    seed_BTUs_per_acre = (seeding_rate_lbs_per_acre / c_wt_lbs) * c_seed_btu_yield_unit,
    
    seed_total_BTUs = seed_BTUs_per_acre * acres_planted,
    
    seed_CO2e_per_acre = (seeding_rate_lbs_per_acre / c_wt_lbs) * c_seed_CO2e_yield_unit,
    
    seed_total_CO2e = seed_CO2e_per_acre * acres_planted,

    #### transportation ####
    # updated with current metrics methodology 04/16/2021
    # assumes diesel for fuel, mileage and truck capacity listed in factors data
    # We are assuming a round-trip with impact of 1.8 instead of 2, to account for fuel efficiency when truck runs #empty in the way back
    truck_miles_per_gallon = 6.5,
    truck_round_trip_coeff = 1.8, # 1 trip + 0.8 trip since the truck in return trip comes back empty
    
    transportation_total_BTUs = (production / c_truck_capacity_yield_output) * ((c_transportation_distance/truck_miles_per_gallon)*gal_diesel_to_BTU) * truck_round_trip_coeff,
    
    transportation_BTUs_per_acre = transportation_total_BTUs / acres_planted,
    
    transportation_total_CO2e = transportation_total_BTUs / gal_diesel_to_BTU * gal_diesel_to_CO2,
    
    transportation_CO2e_per_acre = transportation_total_CO2e / acres_planted,
    
    #### nitrous oxide ####
    # n2o_emissions_factor is the N2O emissions per lb of nitrogen applied, updated from last report, when it was 0.014
    # 44/28 = the molecular weight ratio of N2O/N2O-N
    # Global Warming Potential of N2O = 298, https://www.epa.gov/ghgemissions/overview-greenhouse-gases#N2O-references
    n2o_CO2e_per_acre_primitive = (((fertilizer_nitrogen/acres_planted) + manure_N_lbs_per_acre) * n2o_emissions_factor * (44/28) * 298),
    
    n2o_total_CO2e_primitive = n2o_CO2e_per_acre_primitive * acres_planted, 
    
    # updated equations for N2O
    # Equation 11.1 Direct N2O emissions from managed soils (Tier 1)
    n2o_eq_11_1_per_acre = ifelse(crop == "Rice",
                                  #(((fertilizer_nitrogen/acres_planted) + manure_N_lbs_per_acre) * 0.010) + 
      (((fertilizer_nitrogen/acres_planted) + manure_N_lbs_per_acre) * 0.004),
                                  ((fertilizer_nitrogen/acres_planted) + manure_N_lbs_per_acre) * 0.010),
    
    # Equation 11.9 N2O from atmospheric deposition of N volatilized from managed soils (Tier 1) 11.22, IPCC 2019
    n2o_eq_11_9_per_acre = (((fertilizer_nitrogen/acres_planted) * 0.11) + (manure_N_lbs_per_acre * 0.21)) * 0.010,
    
    # Equation 11.10 N2O from N leaching/runoff from managed soils in regions where leaching/runoff occurs (Tier 1)
    n2o_eq_11_10_per_acre = (((fertilizer_nitrogen/acres_planted) + manure_N_lbs_per_acre) * 0.24) * 0.011,
      
    # Aggregating all three equations above
    n2o_CO2e_per_acre = (n2o_eq_11_1_per_acre + n2o_eq_11_9_per_acre + n2o_eq_11_10_per_acre) * (44/28) * 298,
    
    n2o_total_CO2e = n2o_CO2e_per_acre * acres_planted, 
    
    #### residue burning ####
    ## when divided per acre the number gets highly diluted
    # This indicator was also updated to match current metrics methodology
    
    residue_burning_total_CO2e = acres_planted * (percent_area_burned/100) * yield_planted * c_residue_burning_co2e_lb,
    
    residue_burning_CO2e_per_acre = residue_burning_total_CO2e / acres_planted,
    
    #### Methane emissions for Rice ####
    rice_methane_total_CO2e = ifelse(crop == "Rice", 
                                     methane_CO2e_acre * acres_harvested,
                                     no = 0),
    
    rice_methane_CO2e_per_acre = rice_methane_total_CO2e / acres_planted,
    
    ##### Residue removal credit for Wheat and Barley ####
    # remember to divide acreage share by 100
    # https://ocj.com/2011/07/determining-the-actual-nutrient-value-of-wheat-straw/
    # Facts and assumptions about this residue removal credit
    # Bushel of wheat 60 lbs, bushel of barley 48 lbs
    # Percent N of straw: 0.005 (0.5 percent)
    # Grain to straw production ratio: 1 (very conservative value)
    # Straw production from a bushel of wheat/barley: 60/48 lbs, same as weight of grain (water not included here)
    # N content from pound of straw/wheat = 0.3 lbs N (60 lbs * 0.005)
    # N content from pound of straw/barley = 0.24 lb N (48 lbs * 0.005)
    # Both factors above get divided by 2 (assumption of 50% residue removal)
    # n2o_emissions_factor is the IPCC N loss factor, just 1% basically
    # 298 is the warming potential of N2O, https://www.epa.gov/ghgemissions/overview-greenhouse-gases#N2O-references
    # 44/28 is the Ratio of N2O to N2O-N
    # The number is made negative to subtract from the final value
    residue_removal_credit_total_CO2e = case_when(
      crop == "Wheat" ~ production * (residue_removal_percent_acreage/100) * (0.3/2) * n2o_emissions_factor *
        298 * (44/28) * -1,
      crop == "Barley" ~ production * (residue_removal_percent_acreage/100) * (0.24/2) * n2o_emissions_factor *
        298 * (44/28) * -1,
      TRUE ~ 0
    ),
    
    # To check impact per acre
    residue_removal_credit_CO2e_per_acre = residue_removal_credit_total_CO2e / acres_planted,
    
    #### Application energy ####
    application_total_BTUs = total_application_passes * application_pass_btu * acres_planted,
    
    application_BTUs_per_acre = application_total_BTUs / acres_planted, 
    
    # Application emissions
    application_total_CO2e = (application_total_BTUs / gal_diesel_to_BTU) * gal_diesel_to_CO2,
    
    application_CO2e_per_acre = application_total_CO2e / acres_planted,
    
    #### Total BTUs ####
    total_BTUs_unadjusted = management_total_BTUs + irrigation_total_BTUs + drying_total_BTUs + chemicals_total_BTUs +
      fertilizer_total_BTUs + seed_total_BTUs + transportation_total_BTUs + application_total_BTUs,
    # Calculating BTUs per acreage planted
    #BTUs_per_acre_unadjusted = total_BTUs_unadjusted / acres_planted, # this causes a discrepancy due to irrigation
    BTUs_per_acre_unadjusted = application_BTUs_per_acre + chemicals_BTUs_per_acre + drying_BTUs_per_acre +
      fertilizer_BTUs_per_acre + irrigation_BTUs_per_acre + management_BTUs_per_acre + seed_BTUs_per_acre +
      transportation_BTUs_per_acre, 
    # Calculating BTUs per yield unit
    BTUs_per_yield_unit_unadjusted = total_BTUs_unadjusted / production,
    
    # Total adjusted
    total_BTUs_adjusted = management_total_BTUs + irrigation_total_BTUs + drying_total_BTUs +
      chemicals_total_BTUs_global_adjustment + fertilizer_total_BTUs_adjusted + seed_total_BTUs +
      transportation_total_BTUs + application_total_BTUs,
    # Per acre adjusted
    #BTUs_per_acre_adjusted = total_BTUs_adjusted / acres_planted, # this causes a discrepancy due to irrigation
    BTUs_per_acre_adjusted = application_BTUs_per_acre + chemicals_BTUs_per_acre_global_adjustment +
      drying_BTUs_per_acre + fertilizer_BTUs_per_acre_adjusted + irrigation_BTUs_per_acre + management_BTUs_per_acre +
      seed_BTUs_per_acre + transportation_BTUs_per_acre,

    # Per yield unit adjusted
    BTUs_per_yield_unit_adjusted = total_BTUs_adjusted / production,
    
    #### Total CO2e ####
    # Notice that we use irrigation_total_CO2e_grid_adjusted, drying_total_CO2e_eGRID_adjusted, chemicals_total_co2e_grid_adjusted, and fertilizer_total_co2e_grid_adjusted to account for eGRID efficiency over time
    total_CO2e_adjusted = management_total_CO2e + irrigation_total_CO2e_grid_adjusted +
      drying_total_CO2e_eGRID_adjusted + chemicals_total_CO2e_global_adjustment + fertilizer_total_CO2e_adjusted +
      n2o_total_CO2e + seed_total_CO2e + transportation_total_CO2e + residue_burning_total_CO2e +
      rice_methane_total_CO2e + residue_removal_credit_total_CO2e + application_total_CO2e,
    # Calculating CO2e per acre
    #CO2e_per_acre_adjusted = total_CO2e_adjusted / acres_planted,# this causes a discrepancy due to irrigation
    CO2e_per_acre_adjusted = application_CO2e_per_acre + chemicals_CO2e_per_acre_global_adjustment +
      drying_CO2e_per_acre_eGRID_adjusted + fertilizer_CO2e_per_acre_adjusted + irrigation_CO2e_grid_adjusted_per_acre
    + management_CO2e_per_acre + n2o_CO2e_per_acre + residue_burning_CO2e_per_acre +
      residue_removal_credit_CO2e_per_acre + rice_methane_CO2e_per_acre + seed_CO2e_per_acre +
      transportation_CO2e_per_acre,
    # Calculating CO2e per yield unit
    CO2e_per_yield_unit_adjusted = total_CO2e_adjusted / production,
    
    # Unadjusted below for comparison
    total_CO2e_unadjusted = management_total_CO2e + irrigation_total_CO2e + drying_total_CO2e +
      chemicals_total_CO2e + fertilizer_total_CO2e + n2o_total_CO2e + seed_total_CO2e + transportation_total_CO2e + residue_burning_total_CO2e + rice_methane_total_CO2e + residue_removal_credit_total_CO2e + application_total_CO2e,
    # Calculating CO2e per acre
    #CO2e_per_acre_unadjusted = total_CO2e_unadjusted / acres_planted,# this causes a discrepancy due to irrigation
    CO2e_per_acre_unadjusted = application_CO2e_per_acre + chemicals_CO2e_per_acre + drying_CO2e_per_acre +
      fertilizer_CO2e_per_acre + irrigation_CO2e_per_acre + management_CO2e_per_acre + n2o_CO2e_per_acre +
      residue_burning_CO2e_per_acre + residue_removal_credit_CO2e_per_acre + rice_methane_CO2e_per_acre +
      seed_CO2e_per_acre + transportation_CO2e_per_acre,
    # Calculating CO2e per yield unit
    CO2e_per_yield_unit_unadjusted = total_CO2e_unadjusted / production
    )

# Importing ref table for the many components and units
indicators_components <- read_excel("data_references/indicators and components.xlsx")

# Pulling vector of totals
indicators_components_vector <- indicators_components %>% 
  filter(indicator_type %in% c("Energy", "Emissions")) %>% 
  pull(totals)

# Calculating per-yield-unit variables
input_4 <- input_3 %>% 
  mutate_at(indicators_components_vector,
            .funs = list(PYU_per_yield_unit = ~ ./production))

# Renaming
names(input_4) <- str_replace_all(string = names(input_4), pattern = "total_BTUs_PYU", replacement = "BTUs")
names(input_4) <- str_replace_all(string = names(input_4), pattern = "total_CO2e_PYU", replacement = "CO2e")
#View(names(input_4))

# More renaming
input_4 <- input_4 %>% 
  rename(irrigation_CO2e_grid_adjusted_per_yield_unit = irrigation_total_CO2e_grid_adjusted_PYU_per_yield_unit,
         chemicals_CO2e_global_adjustment_per_yield_unit = chemicals_total_CO2e_global_adjustment_PYU_per_yield_unit,
         fertilizer_CO2e_adjusted_per_yield_unit = fertilizer_total_CO2e_adjusted_PYU_per_yield_unit,
        chemicals_BTUs_global_adjustment_per_yield_unit  = chemicals_total_BTUs_global_adjustment_PYU_per_yield_unit,
        fertilizer_BTUs_adjusted_per_yield_unit = fertilizer_total_BTUs_adjusted_PYU_per_yield_unit,
        drying_CO2e_eGRID_adjusted_per_yield_unit = drying_total_CO2e_eGRID_adjusted_PYU_per_yield_unit
         )

# Checking names
#View(names(input_4))

# Now run cotton 83 pct allocation.R and create cotton_input_4
# Final data frame
NIR_calculated <- input_4 %>% 
  bind_rows(cotton_input_4)

# Exporting final data frame
save(NIR_calculated, file = "r_data/outputs_04_egc.rda")
```

# 05 Dataframes For Shiny App

```{r shiny}

# Load indicators
load("r_data/outputs_04_egc.rda")

# Importing ref table for the many components and units
indicators_components <- read_excel("data_references/indicators and components.xlsx")

# Layout for shiny
# The major indicators
# then partitioned by crops and categories, values and proportions

# Main indicators
vector_main_indicators <- indicators_components %>% 
  filter(indicator_type %in% c("Energy_Indicators_Unadjusted", "Energy_Indicators_Adjusted",
                               "Emissions_Indicators_Unadjusted", "Emissions_Indicators_Adjusted")) %>% 
  select(-indicator_type)

vector_main_indicators <- as.vector(as.matrix(vector_main_indicators))
vector_main_indicators <- c("land_use_fp", "irrigation_water_use_fp", "erosion_rate_tons_acre", "production",
                            "acres_planted", vector_main_indicators)

one_million <- 1000000

# For scatter plots and trends, with year in X-axis and indicators in Y-axis, simple stuff
shiny_main_indicators <- NIR_calculated %>% 
  select(year, crop, all_of(vector_main_indicators)) %>% 
  rename(
    "Acres Planted" = acres_planted,
    "BTU/acre (adjusted)" = BTUs_per_acre_adjusted,
    "BTU/acre (unadjusted)" = BTUs_per_acre_unadjusted,
    "BTU/yield unit (adjusted)" = BTUs_per_yield_unit_adjusted,
    "BTU/yield unit (unadjusted)" = BTUs_per_yield_unit_unadjusted,
    "CO2e/acre (adjusted)" = CO2e_per_acre_adjusted,
    "CO2e/acre (unadjusted)" = CO2e_per_acre_unadjusted,
    "CO2e/yield unit (adjusted)" = CO2e_per_yield_unit_adjusted,
    "CO2e/yield unit (unadjusted)" = CO2e_per_yield_unit_unadjusted,
    "Soil Erosion (tons/acre)" = erosion_rate_tons_acre,
    "Irrigation Water Use" = irrigation_water_use_fp,
    "Land Use" = land_use_fp,
    "Production (yield units)" = production,
    "Total Energy Use (adjusted)" = total_BTUs_adjusted,
    "Total Energy Use (unadjusted)" = total_BTUs_unadjusted,
    "Total GHG Emissions (adjusted)" = total_CO2e_adjusted,
    "Total GHG Emissions (unadjusted)" = total_CO2e_unadjusted
  ) %>% 
  mutate("Acres Planted (Millions)" = `Acres Planted` / one_million,
         "Production (Million Yield Units)" = `Production (yield units)` / one_million,
         "BTU/Acre (Millions)" = `BTU/acre (adjusted)` / one_million
         )

# Components expressed in per-acre basis
# Filtering out unadjusted variables and the residue removal credit
vector_per_acre <- indicators_components %>% 
  filter(indicator_type %in% c("Energy", "Emissions")) %>% 
  filter(!per_acre %in% c("chemicals_BTUs_per_acre", 
                          "fertilizer_BTUs_per_acre", 
                          "irrigation_CO2e_per_acre",
                          "drying_CO2e_per_acre",
                          "chemicals_CO2e_per_acre", 
                          "fertilizer_CO2e_per_acre",
                          "residue_removal_credit_CO2e_per_acre")) %>% 
  pull(per_acre)

shiny_per_acre <- NIR_calculated %>% 
  select(year, crop, all_of(vector_per_acre))

shiny_per_acre_long <- shiny_per_acre %>% 
  gather(key = "attribute",
         value = "value",
         -c(year, crop)) %>% 
  ungroup() %>% 
  mutate(type = ifelse(str_detect(attribute, "BTU"),
                       "Energy",
                       "GHG")) %>% 
  group_by(year, crop, type) %>% 
  mutate(proportion = value/sum(value)) %>%
  ungroup()

# Components expressed in per-yield-unit basis
vector_per_yield_unit <- indicators_components %>% 
  filter(indicator_type %in% c("Energy", "Emissions")) %>% 
  filter(!per_yield_unit %in% c("chemicals_BTUs_per_yield_unit", 
                                "fertilizer_BTUs_per_yield_unit",
                                "irrigation_CO2e_per_yield_unit",
                                "drying_CO2e_per_yield_unit",
                                "chemicals_CO2e_per_yield_unit",
                                "fertilizer_CO2e_per_yield_unit",
                                "residue_removal_credit_CO2e_per_yield_unit")) %>% 
  pull(per_yield_unit)

shiny_per_yield_unit <- NIR_calculated %>% 
  select(year, crop, all_of(vector_per_yield_unit))

shiny_per_yield_unit_long <- shiny_per_yield_unit %>% 
  gather(key = "attribute",
         value = "value",
         -c(year, crop)) %>% 
  ungroup() %>% 
  mutate(type = ifelse(str_detect(attribute, "BTU"),
                       "Energy",
                       "GHG")) %>% 
  group_by(year, crop, type) %>% 
  mutate(proportion = value/sum(value)) %>%
  ungroup()

# Fertilizers and crop protectants
ag_inputs_tillage <- NIR_calculated %>% 
  mutate(n_rate = fertilizer_nitrogen / acres_planted,
         p_rate = fertilizer_phosphate / acres_planted,
         k_rate = fertilizer_potash / acres_planted,
         herb_rate = chemical_herbicide / acres_planted,
         insect_rate = chemical_insecticide / acres_planted,
         fung_rate = chemical_fungicide / acres_planted,
         fumi_rate = chemical_fumigant / acres_planted,
         growth_rate = chemical_growth_reg / acres_planted) %>% 
  select(year, crop, 
         manure_N_lbs_per_acre, manure_rate_all_acreage,
         conventional_till_share, reduced_till_share, no_till_share,
         water_applied_acre_inches,
         n_rate:growth_rate)

# Exporting final data frame for Shiny app
save(shiny_main_indicators,
     #shiny_per_acre,
     shiny_per_acre_long,
     #shiny_per_yield_unit,
     shiny_per_yield_unit_long,
     ag_inputs_tillage,
     file = "app/outputs_for_ShinyApp_egc.rda")
```

# Exporting Excel files by crop. Allison will distribute the data by request.

```{r}
library(xlsx)

# Exporting main indicators, some components, per yield unit and per acre

my_crops_vector <- sort(unique(NIR_calculated$crop))

excel_variables_to_keep <- readxl::read_excel("data_references/vector_for_data_export.xlsx", sheet = 1)

my_variables_to_keep <-  excel_variables_to_keep$variables_to_keep

my_new_names <- excel_variables_to_keep$new_names

for (k in 1:length(my_crops_vector)) {
  
  df_export <- NIR_calculated %>% 
    filter(crop == my_crops_vector[k]) %>% 
    select(all_of(my_variables_to_keep)) %>%
    mutate_at(.vars = c(3), .funs = ~ round(.x, 6)) %>% 
    mutate_at(.vars = c(4), .funs = ~ round(.x, 4)) %>% 
    mutate_at(.vars = c(5:49), .funs = ~ round(.x, 2))

  names(df_export) <- my_new_names
  
  if (my_crops_vector[k] != "Rice") {
    df_export <- df_export %>% 
      select(-c(`Methane GHG Emissions (lb CO2e/acre)`, `Methane GHG Emissions (lb CO2e/yield unit)`))
  }
  
  write.xlsx(as.data.frame(df_export), 
             file = paste0("data_outputs_to_share/", my_crops_vector[k], " 2021 National Indicators Report Data.xlsx"),              sheetName = "Sheet1", col.names = TRUE, row.names = FALSE, append = FALSE)
  
  Sys.sleep(1)

}

# verifying file dimensions, rice is different, it has 2 methane variables

my_files <- list.files("data_outputs_to_share/")

for (q in 1:11) {
  
  value <- readxl::read_excel(paste0("data_outputs_to_share/", (my_files[q]))) %>% dim()
  
  print(value)

}

```